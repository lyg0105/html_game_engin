<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ì•„ì´í…œ ê°•í™” íŒŒë° ê²Œì„</title>
  <style>
    body {
      font-family: sans-serif;
      background: #222;
      color: #eee;
      text-align: center;
    }

    #game {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    #inventory,
    #shop,
    #battle {
      border: 1px solid #555;
      padding: 10px;
      width: 40%;
      border-radius: 10px;
      background: #333;
    }

    #shop.hidden {
      display: none;
    }

    .battle-area.hidden {
      display: none;
    }

    .battle-log.hidden {
      display: none;
    }

    #fieldSelect.hidden {
      display: none;
    }

    .inventory-table {
      width: 100%;
      border-collapse: collapse;
      margin: 5px 0;
      font-size: 12px;
    }

    .inventory-table th {
      background: #444;
      color: #fff;
      padding: 4px;
      text-align: left;
      border: 1px solid #555;
      font-size: 12px;
    }

    .inventory-table td {
      padding: 4px;
      border: 1px solid #555;
      background: #222;
      vertical-align: middle;
    }

    .inventory-table .equipped {
      background: #2a4a2a;
      border: 2px solid #4a8;
    }

    .inventory-table button {
      padding: 4px 8px;
      margin: 2px;
      font-size: 11px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      min-width: 40px;
      min-height: 24px;
      line-height: 1.2;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .inventory-table button:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .inventory-table button:active {
      transform: scale(0.95);
    }

    /* í„°ì¹˜ ê¸°ê¸° ëŒ€ì‘ */
    @media (hover: none) {
      .inventory-table button {
        min-height: 32px;
        min-width: 48px;
        padding: 6px 10px;
      }
    }

    /* ì‘ì€ í™”ë©´ ëŒ€ì‘ */
    @media (max-width: 768px) {
      .inventory-table button {
        font-size: 10px;
        padding: 3px 6px;
        min-width: 35px;
        min-height: 28px;
      }
    }

    .inventory-table .equip-btn {
      background: #4a8;
      color: white;
    }

    .inventory-table .equip-btn:hover {
      background: #5b9;
    }

    .inventory-table .sell-btn {
      background: #a84;
      color: white;
    }

    .inventory-table .sell-btn:hover {
      background: #b95;
    }

    .inventory-table .upgrade-btn {
      background: #84a;
      color: white;
    }

    .inventory-table .upgrade-btn:hover {
      background: #95b;
    }

    .item-name {
      font-weight: bold;
    }

    .equipped-section {
      background: #2a3a2a;
      border: 2px solid #4a8;
      border-radius: 5px;
      padding: 8px;
      margin: 5px 0;
    }

    .equipped-title {
      color: #4f8;
      font-weight: bold;
      margin-bottom: 5px;
      text-align: center;
    }

    .battle-log {
      background: #1a1a1a;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 8px;
      margin: 10px 0;
      height: 100px;
      overflow-y: auto;
      font-size: 12px;
      color: #ccc;
    }

    .log-container {
      margin: 10px 0;
    }

    .log-toggle {
      background: #444;
      color: #fff;
      border: 1px solid #666;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 3px;
      margin-bottom: 5px;
      font-size: 12px;
    }

    .log-toggle:hover {
      background: #555;
    }

    .battle-info {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      pointer-events: none;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .battle-info.show {
      opacity: 1;
    }

    .battle-area {
      position: relative;
    }

    .damage-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 3px 8px;
      border-radius: 3px;
      font-weight: bold;
      font-size: 14px;
      pointer-events: none;
      z-index: 20;
      animation: damageFloat 1s ease-out forwards;
    }

    .damage-popup.heal {
      background: rgba(0, 255, 0, 0.9);
    }

    .damage-popup.gold {
      background: rgba(255, 215, 0, 0.9);
      color: black;
    }

    @keyframes damageFloat {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }

      50% {
        transform: translate(-50%, -70%) scale(1.2);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -100%) scale(0.8);
        opacity: 0;
      }
    }

    @keyframes damageFloatMonster {
      0% {
        transform: translate(-50%, 0) scale(1);
        opacity: 1;
      }

      50% {
        transform: translate(-50%, -20px) scale(1.2);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -40px) scale(0.8);
        opacity: 0;
      }
    }

    button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
    }

    .log {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #555;
      padding: 5px;
      text-align: left;
      background: #111;
    }

    .selected {
      border: 2px solid yellow;
    }

    .monster {
      margin-top: 10px;
    }

    .weapon-common {
      color: #ccc;
    }

    .weapon-rare {
      color: #4af;
      font-weight: bold;
    }

    .weapon-epic {
      color: #a4f;
      font-weight: bold;
    }

    .weapon-legendary {
      color: gold;
      font-weight: bold;
      text-shadow: 0 0 5px gold;
    }

    .weapon-mythic {
      color: red;
      font-weight: bold;
      text-shadow: 0 0 5px red;
    }

    .character-sprite {
      width: 120px;
      height: 120px;
      position: relative;
      margin: 10px auto;
      border: 2px solid #555;
      border-radius: 10px;
      background: linear-gradient(45deg, #2a2a2a, #404040);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      transition: all 0.3s ease;
    }

    .character-sprite.attacking {
      transform: scale(1.1) translateX(5px);
      box-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
    }

    .monster-sprite {
      width: 120px;
      height: 120px;
      position: relative;
      margin: 10px auto;
      border: 2px solid #855;
      border-radius: 10px;
      background: linear-gradient(45deg, #3a1a1a, #501a1a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      transition: all 0.3s ease;
    }

    .monster-sprite.attacking {
      transform: scale(1.1) translateX(-5px);
      box-shadow: 0 0 20px rgba(255, 50, 50, 0.5);
    }

    .monster-sprite.hurt {
      animation: shake 0.3s ease-in-out;
      filter: brightness(1.5) hue-rotate(20deg);
    }

    .character-sprite.hurt {
      animation: shake 0.3s ease-in-out;
      filter: brightness(1.5) hue-rotate(-20deg);
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    .weapon-icon {
      position: absolute;
      right: 5px;
      bottom: 5px;
      font-size: 24px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .battle-area {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(45deg, #1a1a2e, #16213e);
      border-radius: 15px;
      border: 2px solid #333;
      min-height: 400px;
      width: 100%;
      box-sizing: border-box;
      overflow: visible; /* íŒì—…ì´ ë³´ì´ë„ë¡ */
    }

    .battle-unit {
      width: 160px;
      min-width: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: visible; /* íŒì—…ì´ ë³´ì´ë„ë¡ */
    }

    .battle-vs {
      font-size: 30px;
      color: #666;
      min-width: 40px;
      text-align: center;
      flex-shrink: 0;
    }

    .unit_area {
      height: 80px;
      overflow: visible; 
      border: 1px solid #555;
      padding: 5px;
      text-align: left;
      background: #111;
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
    }

    .monster-name {
      text-align: center;
      font-weight: bold;
      margin-bottom: 5px;
      color: #ff6b6b;
    }

    .character-name {
      text-align: center;
      font-weight: bold;
      margin-bottom: 5px;
      color: #4ecdc4;
    }

    .monsters-container {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 110px;
      max-width: 200px;
      max-height: 300px;
      overflow: visible; /* íŒì—…ì´ ë³´ì´ë„ë¡ ë³€ê²½ */
      flex: 1;
    }

    /* ëª¬ìŠ¤í„°ê°€ ë§ì„ ë•Œë¥¼ ìœ„í•œ ìŠ¤í¬ë¡¤ ì˜ì—­ */
    .monsters-scroll-area {
      max-height: 300px;
      overflow-x: visible;
    }

    .monster-unit {
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 3px;
      background: #2a2a2a;
      min-width: 85px;
      margin-bottom: 2px;
      font-size: 13px;
      transition: all 0.3s ease;
    }

    .monster-unit.attacking {
      transform: scale(1.1) translateX(-5px);
      box-shadow: 0 0 20px rgba(255, 50, 50, 0.5);
      background: #4a2a2a;
    }

    .monster-info {
      text-align: center;
      color: #888;
      font-size: 13px;
      padding: 20px;
    }

    /* ìƒì  ìŠ¤íƒ€ì¼ */
    .shop-section {
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #2a2a3a, #1a1a2a);
      border-radius: 10px;
      border: 1px solid #444;
    }

    .shop-section h3 {
      margin: 0 0 10px 0;
      color: #fff;
      font-size: 14px;
      text-align: center;
      text-shadow: 0 0 5px rgba(255,255,255,0.3);
    }

    .shop-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .shop-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
      text-align: center;
      min-width: 90px;
      min-height: 50px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .shop-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }

    .shop-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .shop-btn .price {
      display: block;
      font-size: 10px;
      opacity: 0.9;
      margin-top: 2px;
    }

    /* ê° ë²„íŠ¼ë³„ ìƒ‰ìƒ */
    .gem-btn {
      background: linear-gradient(135deg, #9c27b0, #673ab7);
      color: white;
    }

    .weapon-btn {
      background: linear-gradient(135deg, #f44336, #e91e63);
      color: white;
    }

    .armor-btn {
      background: linear-gradient(135deg, #2196f3, #03a9f4);
      color: white;
    }

    .helmet-btn {
      background: linear-gradient(135deg, #ff9800, #ff5722);
      color: white;
    }

    .pants-btn {
      background: linear-gradient(135deg, #4caf50, #8bc34a);
      color: white;
    }

    .shoes-btn {
      background: linear-gradient(135deg, #795548, #607d8b);
      color: white;
    }

    .necklace-btn {
      background: linear-gradient(135deg, #ffeb3b, #ffc107);
      color: #333;
    }

    .ring-btn {
      background: linear-gradient(135deg, #e91e63, #9c27b0);
      color: white;
    }
  </style>
</head>

<body>
  <h1>ì•„ì´í…œ ê°•í™” íŒŒë° ê²Œì„</h1>
  <div>
    ì½”ì¸: <span id="coins">0</span> | ë³´ì„: <span id="gems">0</span> | ì²˜ì¹˜: <span id="killCount">0</span>ë§ˆë¦¬
    <span id="progressMessage" style="color: #888; font-size: 12px; margin-left: 10px;"></span>
  </div>
  <div id="game">
    <div id="inventory">
      <h2>ì¸ë²¤í† ë¦¬</h2>
      <div id="inventoryList"></div>
    </div>
    <div id="shop">
      <h2>ìƒì </h2>
      <div class="shop-section">
        <h3>ğŸ”¹ ê¸°ë³¸ ì•„ì´í…œ</h3>
        <div class="shop-buttons">
          <button class="shop-btn gem-btn" onclick="buyGem()">ğŸ’ ë³´ì„ êµ¬ë§¤<br><span class="price">50ì½”ì¸</span></button>
          <button class="shop-btn weapon-btn" onclick="buyWeapon()">âš”ï¸ ë¬´ê¸° êµ¬ë§¤<br><span class="price">100ì½”ì¸</span></button>
        </div>
      </div>

      <div class="shop-section">
        <h3>ğŸ›¡ï¸ ë°©ì–´ ì¥ë¹„</h3>
        <div class="shop-buttons">
          <button class="shop-btn armor-btn" onclick="buyArmor()">ğŸ›¡ï¸ ë°©ì–´êµ¬<br><span class="price">120ì½”ì¸</span></button>
          <button class="shop-btn helmet-btn" onclick="buyHelmet()">â›‘ï¸ ëª¨ì<br><span class="price">80ì½”ì¸</span></button>
          <button class="shop-btn pants-btn" onclick="buyPants()">ğŸ‘– ë°”ì§€<br><span class="price">90ì½”ì¸</span></button>
        </div>
      </div>

      <div class="shop-section">
        <h3>ğŸ’ ì•¡ì„¸ì„œë¦¬</h3>
        <div class="shop-buttons">
          <button class="shop-btn shoes-btn" onclick="buyShoes()">ğŸ‘ ì‹ ë°œ<br><span class="price">70ì½”ì¸</span></button>
          <button class="shop-btn necklace-btn" onclick="buyNecklace()">ğŸ“¿ ëª©ê±¸ì´<br><span class="price">150ì½”ì¸</span></button>
          <button class="shop-btn ring-btn" onclick="buyRing()">ğŸ’ ë°˜ì§€<br><span class="price">110ì½”ì¸</span></button>
        </div>
      </div>
    </div>
    <div id="battle">
      <h2>ì‚¬ëƒ¥í„°</h2>
      <div class="battle-area">
        <div class="battle-info" id="battleInfo"></div>
        <div class="battle-unit">
          <div class="character-name">ìš©ì‚¬</div>
          <div class="character-sprite" id="characterSprite">ğŸ§™â€â™‚ï¸
            <div class="weapon-icon" id="weaponIcon"></div>
          </div>
          <div class="unit_area" id="playerArea"></div>
        </div>
        <div class="battle-vs">âš”ï¸</div>
        <div class="monsters-container" id="monstersContainer">
          <div class="monster-info">ëª¬ìŠ¤í„° ì—†ìŒ</div>
        </div>
      </div>
      <div class="battle-log" id="battleLog"></div>
      <div id="fieldSelect"></div>
      <div id="huntControls">
        <button onclick="toggleAutoHunt()" id="autoHuntBtn">ì‚¬ëƒ¥ì‹œì‘</button>
      </div>
    </div>
  </div>
  <div class="log-container">
    <button class="log-toggle" onclick="toggleLog()" id="logToggle">ë¡œê·¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
    <div class="log" id="log" style="display: none;"></div>
  </div>

  <script>
    let coins = 200;
    let gems = 3;
    let inventory = [];
    let armorInventory = [];
    let helmetInventory = [];
    let pantsInventory = [];
    let shoesInventory = [];
    let necklaceInventory = [];
    let ringInventory = [];
    let equipped = null;
    let equippedArmor = null;
    let equippedHelmet = null;
    let equippedPants = null;
    let equippedShoes = null;
    let equippedNecklace = null;
    let equippedRing = null;
    let monsters = [];
    let monsterIdCounter = 0; // ëª¬ìŠ¤í„° ê³ ìœ  ID ì¹´ìš´í„°
    let player = {
      hp: 100,
      maxHp: 100,
      atkSpd: 800, // ms, ê³µê²©ì†ë„(ë‚®ì„ìˆ˜ë¡ ë¹ ë¦„)
      alive: true,
      def: 0, // ë°©ì–´ë ¥
      dodge: 0, // íšŒí”¼ìœ¨ (ëª¨ì)
      speed: 0, // ì´ë™ì†ë„ (ë°”ì§€)
      jump: 0, // ì í”„ë ¥ (ì‹ ë°œ)
      bonusHp: 0, // ì¶”ê°€ ì²´ë ¥ (ëª©ê±¸ì´)
      bonusAtk: 0 // ì¶”ê°€ ê³µê²©ë ¥ (ë°˜ì§€)
    };

    let autoHunt = false;
    let autoHuntTimeout = null;

    // ì‚¬ëƒ¥í„° ì •ë³´ (ëª¬ìŠ¤í„° ìˆ˜ëŠ” [ìµœì†Œ, ìµœëŒ€] ë²”ìœ„, unlock: í•´ê¸ˆ ì¡°ê±´)
    const fields = [
      { name: "ì´ˆì›", hp: [50, 90], atk: [5, 12], def: [5, 15], reward: 35, monsterCount: [1, 3], unlock: 0 },
      { name: "ìˆ²", hp: [120, 200], atk: [18, 30], def: [15, 25], reward: 70, monsterCount: [1, 3], unlock: 10 },
      { name: "ë™êµ´", hp: [220, 350], atk: [28, 50], def: [25, 40], reward: 130, monsterCount: [2, 4], unlock: 30 },
      { name: "í™”ì‚°", hp: [400, 700], atk: [45, 90], def: [40, 60], reward: 220, monsterCount: [2, 5], unlock: 60 },
      { name: "ë¹™í•˜", hp: [800, 1200], atk: [80, 140], def: [70, 100], reward: 380, monsterCount: [3, 6], unlock: 100 },
      { name: "ì‚¬ë§‰", hp: [1300, 1800], atk: [120, 200], def: [90, 140], reward: 550, monsterCount: [3, 7], unlock: 150 },
      { name: "ì‹¬ì—°", hp: [2000, 2800], atk: [180, 280], def: [130, 180], reward: 750, monsterCount: [4, 8], unlock: 220 },
      { name: "ì²œê³µì„±", hp: [3000, 4200], atk: [250, 380], def: [170, 230], reward: 1050, monsterCount: [4, 9], unlock: 300 },
      { name: "ì–´ë‘ ì˜ ì˜ì—­", hp: [4500, 6000], atk: [320, 480], def: [210, 280], reward: 1400, monsterCount: [5, 10], unlock: 400 },
      { name: "ì‹œê³µì˜ í‹ˆ", hp: [6500, 8500], atk: [420, 600], def: [260, 340], reward: 1900, monsterCount: [6, 12], unlock: 520 },
      { name: "ì ˆëŒ€ì‹ ì—­", hp: [9000, 12000], atk: [550, 750], def: [320, 420], reward: 2600, monsterCount: [7, 15], unlock: 666 }
    ];

    let totalMonstersKilled = 0; // ì´ ì²˜ì¹˜í•œ ëª¬ìŠ¤í„° ìˆ˜ (ê²Œì„ ì§„í–‰ë„ ì¸¡ì •)
    let currentField = 0;
    function updateFieldSelect() {
      const el = document.getElementById("fieldSelect");
      el.innerHTML = fields.map((f, i) => {
        const isUnlocked = totalMonstersKilled >= f.unlock;
        const isSelected = currentField === i;
        const disabled = !isUnlocked ? 'disabled' : '';
        const style = isSelected ? "background:#fa4;color:#fff;" : (isUnlocked ? "background:#333;color:#fff;" : "background:#666;color:#999;");
        const onclick = isUnlocked ? `selectField(${i})` : '';
        const unlockText = isUnlocked ? '' : ` (${f.unlock}ë§ˆë¦¬)`;
        return `<button ${disabled} onclick='${onclick}' style='${style}margin:2px;padding:5px 8px;border:1px solid #777;border-radius:3px;cursor:${isUnlocked ? 'pointer' : 'not-allowed'};'>${f.name}${unlockText}</button>`;
      }).join("");
    }
    function selectField(idx) {
      // í•´ê¸ˆ ì¡°ê±´ í™•ì¸
      if (totalMonstersKilled < fields[idx].unlock) {
        log(`${fields[idx].name}ì€(ëŠ”) ${fields[idx].unlock}ë§ˆë¦¬ ì²˜ì¹˜ í›„ í•´ê¸ˆë©ë‹ˆë‹¤. (í˜„ì¬: ${totalMonstersKilled}ë§ˆë¦¬)`);
        return;
      }

      currentField = idx;
      log(`ì‚¬ëƒ¥í„°ë¥¼ [${fields[idx].name}]ìœ¼ë¡œ ì´ë™!`);
      updateFieldSelect();
      // ìë™ì‚¬ëƒ¥ ì¤‘ì´ë©´ ì¦‰ì‹œ ëª¬ìŠ¤í„° ë¦¬ìŠ¤í°
      if (autoHunt) {
        // ëª¨ë“  ëª¬ìŠ¤í„° ì œê±°
        monsters.length = 0;
        updateMonstersDisplay();
        if (autoHuntTimeout) clearTimeout(autoHuntTimeout);
        // ê¸°ë³¸ ë”œë ˆì´ 3ì´ˆ, ì í”„ë ¥ì— ë”°ë¼ ê°ì†Œ (ìµœì†Œ 0.5ì´ˆ)
        const baseDelay = 3000;
        const jumpReduction = player.jump * 50; // ì í”„ë ¥ 1ë‹¹ 50ms ê°ì†Œ
        const finalDelay = Math.max(500, baseDelay - jumpReduction);
        autoHuntTimeout = setTimeout(() => { spawnMonster(); }, finalDelay);
      }
    }

    function toggleAutoHunt() {
      autoHunt = !autoHunt;
      document.getElementById("autoHuntBtn").textContent = (autoHunt ? "ì‚¬ëƒ¥ì¢…ë£Œ" : "ì‚¬ëƒ¥ì‹œì‘");

      if (autoHunt) {
        // ì‚¬ëƒ¥ ì‹œì‘: ì‚´ì•„ìˆëŠ” ëª¬ìŠ¤í„°ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        if (monsters.filter(m => m.alive).length === 0) {
          spawnMonster();
        } else {
          // ì´ë¯¸ ì‚´ì•„ìˆëŠ” ëª¬ìŠ¤í„°ê°€ ìˆìœ¼ë©´ ì „íˆ¬ ì‹œì‘
          if (equipped != null && inventory[equipped]) {
            startAutoBattle();
          }
        }
      } else {
        // ì‚¬ëƒ¥ ì¢…ë£Œ: ì „íˆ¬ ì¤‘ë‹¨í•˜ê³  ëª¬ìŠ¤í„°ë“¤ ì •ë¦¬
        if (autoBattleInterval) clearInterval(autoBattleInterval);
        if (autoHuntTimeout) clearTimeout(autoHuntTimeout);
        monsters.length = 0; // ëª¨ë“  ëª¬ìŠ¤í„° ì œê±°
        updateMonstersDisplay();
      }

      updateUIVisibility(); // ìë™ì‚¬ëƒ¥ ìƒíƒœ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
    }

    // ë°©ì–´êµ¬ ì¢…ë¥˜
    const armors = [
      { name: "ê°€ì£½ ê°‘ì˜·", baseDef: [30, 50] },
      { name: "ì‚¬ìŠ¬ ê°‘ì˜·", baseDef: [40, 70] },
      { name: "ì²  ê°‘ì˜·", baseDef: [70, 120] },
      { name: "ë§ˆë²• ë¡œë¸Œ", baseDef: [30, 80] },
      { name: "ë“œë˜ê³¤ ê°‘ì˜·", baseDef: [100, 180] }
    ];

    // ëª¨ì ì¢…ë¥˜ (íšŒí”¼ìœ¨ ì¦ê°€, ìµœëŒ€ 75%ê¹Œì§€)
    const helmets = [
      { name: "ê°€ì£½ ëª¨ì", baseDodge: [5, 10] },
      { name: "ì²  ê°€ë©´", baseDodge: [8, 15] },
      { name: "ë§ˆë²• ëª¨ì", baseDodge: [12, 20] },
      { name: "ë…¸ë¸” ì™•ê´€", baseDodge: [15, 25] },
      { name: "ë“œë˜ê³¤ í—¬ë¦„", baseDodge: [20, 30] }
    ];

    // ë°”ì§€ ì¢…ë¥˜ (ì´ë™ì†ë„ ì¦ê°€)
    const pants = [
      { name: "ê°€ì£½ ë°”ì§€", baseSpeed: [5, 10] },
      { name: "ë§ˆë²• ë°”ì§€", baseSpeed: [8, 15] },
      { name: "ë‹¬ë¦¬ê¸° ë°”ì§€", baseSpeed: [12, 20] },
      { name: "ë°”ëŒ ë°”ì§€", baseSpeed: [15, 25] },
      { name: "ë¦¬ë² ë¥´íƒ€ìŠ¤ ë°”ì§€", baseSpeed: [20, 35] }
    ];

    // ì‹ ë°œ ì¢…ë¥˜ (ì í”„ë ¥ ì¦ê°€)
    const shoes = [
      { name: "ê°€ì£½ ì‹ ë°œ", baseJump: [3, 8] },
      { name: "ì „ì‚¬ ë¶€ì¸ ", baseJump: [5, 12] },
      { name: "ë‹¬ë¦¬ê¸° ì‹ ë°œ", baseJump: [8, 15] },
      { name: "ë°”ëŒ ì‹ ë°œ", baseJump: [12, 20] },
      { name: "ë¹„ìƒ ì‹ ë°œ", baseJump: [15, 30] }
    ];

    // ëª©ê±¸ì´ ì¢…ë¥˜ (ì²´ë ¥ ì¦ê°€)
    const necklaces = [
      { name: "ì²­ë™ ëª©ê±¸ì´", baseHp: [20, 40] },
      { name: "ì€ ëª©ê±¸ì´", baseHp: [30, 60] },
      { name: "ê¸ˆ ëª©ê±¸ì´", baseHp: [50, 80] },
      { name: "ë§ˆë²• ëª©ê±¸ì´", baseHp: [70, 120] },
      { name: "ë“œë˜ê³¤ ëª©ê±¸ì´", baseHp: [100, 180] }
    ];

    // ë°˜ì§€ ì¢…ë¥˜ (ê³µê²©ë ¥ ì¦ê°€)
    const rings = [
      { name: "ì²­ë™ ë°˜ì§€", baseAtk: [1, 2] },
      { name: "ì€ ë°˜ì§€", baseAtk: [1, 3] },
      { name: "ê¸ˆ ë°˜ì§€", baseAtk: [2, 4] },
      { name: "ë§ˆë²• ë°˜ì§€", baseAtk: [2, 5] },
      { name: "ë“œë˜ê³¤ ë°˜ì§€", baseAtk: [1, 10] }
    ];

    const ITEM_OPTIONS = [
      { key: "ê³µê²©ë ¥", type: "atk", value: [1, 5], "pre": "+", "after": "" },
      { key: "ë°©ì–´ë ¥", type: "def", value: [10, 50], "pre": "+", "after": "" },
      { key: "ì²´ë ¥", type: "hp", value: [5, 20], "pre": "+", "after": "" },
      { key: "íšŒí”¼ìœ¨", type: "dodge", value: [1, 4], "pre": "+", "after": "%" },
      { key: "ì†ë„", type: "speed", value: [1, 8], "pre": "+", "after": "" },
      { key: "ì í”„ë ¥", type: "jump", value: [5, 25], "pre": "+", "after": "" }
    ];

    // ìœ ë‹ˆí¬ ê³ ìœ  ì˜µì…˜ë“¤
    const UNIQUE_OPTIONS = {
      // ê³µê²©ì‹œ ë°œë™ íš¨ê³¼
      attack_triggers: [
        { key: "ê³µê²©ì‹œ 10% í™•ë¥ ë¡œ ë²ˆê°œ ë°œìƒ (ì¶”ê°€ 50% ë°ë¯¸ì§€)", type: "lightning_strike", chance: 10, value: 0.5 },
        { key: "ê³µê²©ì‹œ 15% í™•ë¥ ë¡œ ë… ê°ì—¼ (3ì´ˆê°„ DOT)", type: "poison_attack", chance: 15, value: 3 },
        { key: "ê³µê²©ì‹œ 1% í™•ë¥ ë¡œ ì¦‰ì‚¬ ê³µê²©", type: "instant_kill", chance: 1, value: 1 },
        { key: "ê³µê²©ì‹œ 20% í™•ë¥ ë¡œ ì²´ë ¥ í¡ìˆ˜ (ë°ë¯¸ì§€ì˜ 30%)", type: "life_steal", chance: 20, value: 0.3 },
        { key: "ê³µê²©ì‹œ 12% í™•ë¥ ë¡œ í™”ì—¼ í­ë°œ (ì£¼ë³€ ì  ë™ì‹œ ê³µê²©)", type: "fire_explosion", chance: 12, value: 0.8 }
      ],

      // ë°©ì–´ì‹œ ë°œë™ íš¨ê³¼
      defense_triggers: [
        { key: "í”¼ê²©ì‹œ 15% í™•ë¥ ë¡œ ê°€ì‹œ ë°˜ì‚¬ (ë°›ì€ ë°ë¯¸ì§€ì˜ 50% ë°˜ì‚¬)", type: "thorn_reflect", chance: 15, value: 0.5 },
        { key: "í”¼ê²©ì‹œ 10% í™•ë¥ ë¡œ ìˆœê°„ì´ë™ (2ì´ˆê°„ ë¬´ì )", type: "teleport_dodge", chance: 10, value: 2 },
        { key: "í”¼ê²©ì‹œ 10% í™•ë¥ ë¡œ ë°©ì–´ë§‰ ìƒì„± (ë‹¤ìŒ ê³µê²© ë¬´íš¨í™”)", type: "shield_barrier", chance: 20, value: 1 },
        { key: "í”¼ê²©ì‹œ 5% í™•ë¥ ë¡œ ì¦‰ì‹œ ì²´ë ¥ íšŒë³µ (ìµœëŒ€ ì²´ë ¥ì˜ 20%)", type: "auto_heal", chance: 5, value: 0.2 },
        { key: "í”¼ê²©ì‹œ 4% í™•ë¥ ë¡œ ì‹œê°„ ì •ì§€ (ëª¬ìŠ¤í„° 3ì´ˆê°„ ë§ˆë¹„)", type: "time_freeze", chance: 4, value: 3 }
      ],

      // í¼ì„¼íŠ¸ ì¦ê°€ ìŠ¤íƒ¯
      percentage_stats: [
        { key: "ëª¨ë“  ê³µê²©ë ¥ 25% ì¦ê°€", type: "attack_percent", value: 25 },
        { key: "ëª¨ë“  ë°©ì–´ë ¥ 30% ì¦ê°€", type: "defense_percent", value: 30 },
        { key: "ìµœëŒ€ ì²´ë ¥ 40% ì¦ê°€", type: "hp_percent", value: 40 },
        { key: "ê³µê²© ì†ë„ 20% ì¦ê°€", type: "speed_percent", value: 20 },
        { key: "ê²½í—˜ì¹˜ íšë“ 50% ì¦ê°€", type: "exp_percent", value: 50 },
        { key: "ê³¨ë“œ íšë“ 35% ì¦ê°€", type: "gold_percent", value: 35 },
        { key: "ì¹˜ëª…íƒ€ í™•ë¥  15% ì¦ê°€", type: "crit_percent", value: 15 },
        { key: "ëª¨ë“  ì €í•­ 20% ì¦ê°€", type: "resist_percent", value: 20 }
      ],

      // íŠ¹ìˆ˜ ëŠ¥ë ¥
      special_abilities: [
        { key: "ë¶ˆì‚¬ì‹ ì˜ ì¶•ë³µ (ì‚¬ë§ì‹œ 1íšŒ ë¶€í™œ)", type: "resurrection", value: 1 },
        { key: "ë§ˆë‚˜ í¡ìˆ˜ (ì²˜ì¹˜ì‹œ ë³´ì„ íšë“ í™•ë¥  +10%)", type: "mana_drain", value: 10 },
        { key: "ì‹œê°„ ê°€ì† (ëª¬ìŠ¤í„° ë¦¬ìŠ¤í° ì‹œê°„ 50% ê°ì†Œ)", type: "time_acceleration", value: 50 },
        { key: "í–‰ìš´ì˜ ê°€í˜¸ (ëª¨ë“  í™•ë¥  íš¨ê³¼ 2ë°°)", type: "luck_blessing", value: 2 },
        { key: "ë¬´í•œ ì¸ë²¤í† ë¦¬ (ì•„ì´í…œ ìë™ íŒë§¤)", type: "auto_sell", value: 1 }
      ]
    };
    function getRandomOption() {
      let select_option = ITEM_OPTIONS[Math.floor(Math.random() * ITEM_OPTIONS.length)];
      let ran_val = randBetween(select_option.value[0], select_option.value[1]);
      let key_str = select_option.key + " " + select_option.pre + " " + ran_val + " " + select_option.after;
      let option = {
        key: key_str,
        type: select_option.type,
        value: ran_val
      };
      return option;
    }

    function getRandomUniqueOption() {
      // ìœ ë‹ˆí¬ ì˜µì…˜ ì¹´í…Œê³ ë¦¬ ëœë¤ ì„ íƒ
      const categories = Object.keys(UNIQUE_OPTIONS);
      const selectedCategory = categories[Math.floor(Math.random() * categories.length)];
      const categoryOptions = UNIQUE_OPTIONS[selectedCategory];

      // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì—ì„œ ëœë¤ ì˜µì…˜ ì„ íƒ
      const selectedOption = categoryOptions[Math.floor(Math.random() * categoryOptions.length)];

      return {
        key: selectedOption.key,
        type: selectedOption.type,
        category: selectedCategory,
        chance: selectedOption.chance || null,
        value: selectedOption.value,
        isUnique: true
      };
    }

    function getRandomOptions(grade) {
      let options = [];

      if (grade === "ë§¤ì§") {
        // ë§¤ì§: ì¼ë°˜ ì˜µì…˜ 1ê°œ
        let option = getRandomOption();
        options.push(option);
      } else if (grade === "ë ˆì–´") {
        // ë ˆì–´: ì¼ë°˜ ì˜µì…˜ 2ê°œ
        let usedTypes = new Set();
        for (let i = 0; i < 2; i++) {
          let attempts = 0;
          let option;
          do {
            option = getRandomOption();
            attempts++;
          } while (usedTypes.has(option.type) && attempts < 10);

          if (!usedTypes.has(option.type)) {
            usedTypes.add(option.type);
            options.push(option);
          }
        }
      } else if (grade === "ìœ ë‹ˆí¬") {
        // ìœ ë‹ˆí¬: ì¼ë°˜ ì˜µì…˜ 1ê°œ + ê³ ìœ  ì˜µì…˜ 1ê°œ
        let normalOption = getRandomOption();
        let uniqueOption = getRandomUniqueOption();
        options.push(normalOption);
        options.push(uniqueOption);
      }

      return options;
    }

    // ì¥ë¹„ì˜ ì˜µì…˜ íš¨ê³¼ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    function getItemOptionStats(item) {
      let stats = {
        atk: 0,
        def: 0,
        hp: 0,
        dodge: 0,
        speed: 0,
        jump: 0
      };

      if (item && item.options) {
        item.options.forEach(option => {
          if (stats.hasOwnProperty(option.type)) {
            stats[option.type] += option.value;
          }
        });
      }

      return stats;
    }

    // ìœ ë‹ˆí¬ ê³µê²© íš¨ê³¼ ì²˜ë¦¬ í•¨ìˆ˜
    function processUniqueAttackEffects(targetMonster, damage) {
      let extraDamage = 0;
      let extraMessage = "";
      let healAmount = 0;

      // ëª¨ë“  ì¥ì°©ëœ ì•„ì´í…œì˜ ìœ ë‹ˆí¬ ì˜µì…˜ í™•ì¸
      const allEquippedItems = [
        equipped !== null ? inventory[equipped] : null,
        equippedArmor !== null ? armorInventory[equippedArmor] : null,
        equippedHelmet !== null ? helmetInventory[equippedHelmet] : null,
        equippedPants !== null ? pantsInventory[equippedPants] : null,
        equippedShoes !== null ? shoesInventory[equippedShoes] : null,
        equippedNecklace !== null ? necklaceInventory[equippedNecklace] : null,
        equippedRing !== null ? ringInventory[equippedRing] : null
      ].filter(item => item !== null);

      allEquippedItems.forEach(item => {
        if (item.options) {
          item.options.forEach(option => {
            if (option.isUnique && option.category === 'attack_triggers') {
              let chance = option.chance || 0;

              // í–‰ìš´ì˜ ê°€í˜¸ íš¨ê³¼ ì ìš©
              let luckMultiplier = hasUniqueOption('luck_blessing') ? getUniqueOptionValue('luck_blessing') : 1;
              chance *= luckMultiplier;

              if (Math.random() * 100 < chance) {
                switch (option.type) {
                  case 'lightning_strike':
                    extraDamage += damage * option.value;
                    extraMessage += " âš¡ë²ˆê°œ ë°œìƒ!";
                    break;

                  case 'poison_attack':
                    // DOT íš¨ê³¼ëŠ” ë‚˜ì¤‘ì— êµ¬í˜„ (ê°„ë‹¨íˆ ì¦‰ì‹œ ì¶”ê°€ ë°ë¯¸ì§€ë¡œ ì²˜ë¦¬)
                    extraDamage += damage * 0.3;
                    extraMessage += " ğŸ§ªë… ê°ì—¼!";
                    break;

                  case 'instant_kill':
                    if (targetMonster.hp < targetMonster.maxHp * 0.8) { // ì²´ë ¥ 80% ì´í•˜ì¼ ë•Œë§Œ
                      extraDamage = targetMonster.hp;
                      extraMessage += " â˜ ï¸ì¦‰ì‚¬ ê³µê²©!";
                    }
                    break;

                  case 'life_steal':
                    healAmount = damage * option.value;
                    extraMessage += " ğŸ©¸ì²´ë ¥ í¡ìˆ˜!";
                    break;

                  case 'fire_explosion':
                    // ëª¨ë“  ì‚´ì•„ìˆëŠ” ëª¬ìŠ¤í„°ì—ê²Œ ì¶”ê°€ ë°ë¯¸ì§€ (ì£¼ íƒ€ê²Ÿ ì œì™¸)
                    let otherMonsters = monsters.filter(m => m.alive && m !== targetMonster);
                    otherMonsters.forEach(monster => {
                      let explosionDamage = damage * option.value;
                      monster.hp -= explosionDamage;

                      // í™”ì—¼ í­ë°œ ë°ë¯¸ì§€ íŒì—… í‘œì‹œ
                      showMonsterDamagePopup(monster.id, explosionDamage, 'damage');

                      if (monster.hp <= 0) {
                        monster.alive = false;
                        const reward = fields[currentField].reward;
                        coins += reward;
                        totalMonstersKilled++;
                      }
                    });
                    extraMessage += " ğŸ”¥í™”ì—¼ í­ë°œ!";
                    break;
                }
              }
            }
          });
        }
      });

      // ì²´ë ¥ í¡ìˆ˜ ì ìš©
      if (healAmount > 0) {
        const currentMaxHp = player.maxHp + player.bonusHp;
        player.hp = Math.min(currentMaxHp, player.hp + healAmount);
        showDamagePopup(document.getElementById("characterSprite"), Math.floor(healAmount), 'heal');
      }

      return { extraDamage, extraMessage };
    }

    // ìœ ë‹ˆí¬ ì˜µì…˜ ë³´ìœ  í™•ì¸ í•¨ìˆ˜
    function hasUniqueOption(optionType) {
      const allEquippedItems = [
        equipped !== null ? inventory[equipped] : null,
        equippedArmor !== null ? armorInventory[equippedArmor] : null,
        equippedHelmet !== null ? helmetInventory[equippedHelmet] : null,
        equippedPants !== null ? pantsInventory[equippedPants] : null,
        equippedShoes !== null ? shoesInventory[equippedShoes] : null,
        equippedNecklace !== null ? necklaceInventory[equippedNecklace] : null,
        equippedRing !== null ? ringInventory[equippedRing] : null
      ].filter(item => item !== null);

      for (let item of allEquippedItems) {
        if (item.options) {
          for (let option of item.options) {
            if (option.isUnique && option.type === optionType) {
              return true;
            }
          }
        }
      }
      return false;
    }

    // ìœ ë‹ˆí¬ ì˜µì…˜ ê°’ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getUniqueOptionValue(optionType) {
      const allEquippedItems = [
        equipped !== null ? inventory[equipped] : null,
        equippedArmor !== null ? armorInventory[equippedArmor] : null,
        equippedHelmet !== null ? helmetInventory[equippedHelmet] : null,
        equippedPants !== null ? pantsInventory[equippedPants] : null,
        equippedShoes !== null ? shoesInventory[equippedShoes] : null,
        equippedNecklace !== null ? necklaceInventory[equippedNecklace] : null,
        equippedRing !== null ? ringInventory[equippedRing] : null
      ].filter(item => item !== null);

      for (let item of allEquippedItems) {
        if (item.options) {
          for (let option of item.options) {
            if (option.isUnique && option.type === optionType) {
              return option.value;
            }
          }
        }
      }
      return 0;
    }

    // ìœ ë‹ˆí¬ ë°©ì–´ íš¨ê³¼ ì²˜ë¦¬ í•¨ìˆ˜
    function processUniqueDefenseEffects(incomingDamage) {
      let damageReduction = 0;
      let reflectDamage = 0;
      let extraMessage = "";
      let negateAttack = false;
      let healAmount = 0;

      // ëª¨ë“  ì¥ì°©ëœ ì•„ì´í…œì˜ ìœ ë‹ˆí¬ ì˜µì…˜ í™•ì¸
      const allEquippedItems = [
        equipped !== null ? inventory[equipped] : null,
        equippedArmor !== null ? armorInventory[equippedArmor] : null,
        equippedHelmet !== null ? helmetInventory[equippedHelmet] : null,
        equippedPants !== null ? pantsInventory[equippedPants] : null,
        equippedShoes !== null ? shoesInventory[equippedShoes] : null,
        equippedNecklace !== null ? necklaceInventory[equippedNecklace] : null,
        equippedRing !== null ? ringInventory[equippedRing] : null
      ].filter(item => item !== null);

      allEquippedItems.forEach(item => {
        if (item.options) {
          item.options.forEach(option => {
            if (option.isUnique && option.category === 'defense_triggers') {
              let chance = option.chance || 0;

              // í–‰ìš´ì˜ ê°€í˜¸ íš¨ê³¼ ì ìš©
              let luckMultiplier = hasUniqueOption('luck_blessing') ? getUniqueOptionValue('luck_blessing') : 1;
              chance *= luckMultiplier;

              if (Math.random() * 100 < chance) {
                switch (option.type) {
                  case 'thorn_reflect':
                    let reflectAmount = incomingDamage * option.value;
                    if (isNaN(reflectAmount)) {
                      reflectAmount = 0;
                    }
                    reflectDamage += reflectAmount;
                    extraMessage += " ğŸŒ¿ê°€ì‹œ ë°˜ì‚¬!";
                    break;

                  case 'teleport_dodge':
                    negateAttack = true;
                    extraMessage += " ğŸŒ€ìˆœê°„ì´ë™!";
                    break;

                  case 'shield_barrier':
                    negateAttack = true;
                    extraMessage += " ğŸ›¡ï¸ë°©ì–´ë§‰!";
                    break;

                  case 'auto_heal':
                    const currentMaxHp = player.maxHp + player.bonusHp;
                    healAmount = currentMaxHp * option.value;
                    if (isNaN(healAmount)) {
                      healAmount = 0;
                    }
                    extraMessage += " ğŸ’šìë™ íšŒë³µ!";
                    break;

                  case 'time_freeze':
                    // ëª¬ìŠ¤í„°ë“¤ì„ ì¼ì‹œì ìœ¼ë¡œ ë§ˆë¹„ì‹œí‚´ (ê°„ë‹¨íˆ 1í„´ ìŠ¤í‚µìœ¼ë¡œ ì²˜ë¦¬)
                    extraMessage += " â°ì‹œê°„ ì •ì§€!";
                    negateAttack = true;
                    break;
                }
              }
            }
          });
        }
      });

      // NaN ì²´í¬
      if (isNaN(reflectDamage)) {
        reflectDamage = 0;
      }
      if (isNaN(healAmount)) {
        healAmount = 0;
      }

      // ë°˜ì‚¬ ë°ë¯¸ì§€ ì ìš©
      if (reflectDamage > 0) {
        monsters.filter(m => m.alive).forEach((monster, index) => {
          monster.hp -= reflectDamage;

          // ë°˜ì‚¬ ë°ë¯¸ì§€ íŒì—… í‘œì‹œ
          showMonsterDamagePopup(monster.id, reflectDamage, 'damage');

          if (monster.hp <= 0) {
            monster.alive = false;
            const reward = fields[currentField].reward;
            coins += reward;
            totalMonstersKilled++;
            battleLog(`${monster.name} ë°˜ì‚¬ ë°ë¯¸ì§€ë¡œ ì²˜ì¹˜!`);
          }
        });
      }

      // ìë™ íšŒë³µ ì ìš©
      if (healAmount > 0) {
        const currentMaxHp = player.maxHp + player.bonusHp;
        player.hp = Math.min(currentMaxHp, player.hp + healAmount);
        showDamagePopup(document.getElementById("characterSprite"), Math.floor(healAmount), 'heal');
      }

      // ë°˜í™˜ê°’ NaN ì²´í¬
      let finalReflectDamage = Math.floor(reflectDamage);
      if (isNaN(finalReflectDamage)) {
        finalReflectDamage = 0;
      }

      return {
        damageReduction,
        extraMessage,
        negateAttack,
        reflectDamage: finalReflectDamage
      };
    }

    function buyArmor() {
      if (coins >= 120) {
        coins -= 120;
        const templateIndex = weightedRandom(armors);
        const template = armors[templateIndex];
        const grade = randomGrade();
        const a = JSON.parse(JSON.stringify(template));
        a.grade = grade.name;
        a.gradeColor = grade.color;
        a.baseDef = Math.round(randBetween(template.baseDef[0], template.baseDef[1]) * grade.stat);
        a.upgrade = 0;
        a.options = getRandomOptions(grade.name);
        armorInventory.push(a);
        log(`<span style='color:${grade.color}'>[${grade.name}]</span> ${a.name} (ë°©ì–´:${a.baseDef}) íšë“!`);
        updateDisplay();
      } else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }

    function buyHelmet() {
      if (coins >= 80) {
        coins -= 80;
        const templateIndex = weightedRandom(helmets);
        const template = helmets[templateIndex];
        const grade = randomGrade();
        const h = JSON.parse(JSON.stringify(template));
        h.grade = grade.name;
        h.gradeColor = grade.color;
        h.baseDodge = Math.round(randBetween(template.baseDodge[0], template.baseDodge[1]) * grade.stat);
        h.upgrade = 0;
        h.options = getRandomOptions(grade.name);
        helmetInventory.push(h);
        log(`<span style='color:${grade.color}'>[${grade.name}]</span> ${h.name} (íšŒí”¼:${h.baseDodge}%) íšë“!`);
        updateDisplay();
      } else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }

    function buyPants() {
      if (coins >= 90) {
        coins -= 90;
        const templateIndex = weightedRandom(pants);
        const template = pants[templateIndex];
        const grade = randomGrade();
        const p = JSON.parse(JSON.stringify(template));
        p.grade = grade.name;
        p.gradeColor = grade.color;
        p.baseSpeed = Math.round(randBetween(template.baseSpeed[0], template.baseSpeed[1]) * grade.stat);
        p.upgrade = 0;
        p.options = getRandomOptions(grade.name);
        pantsInventory.push(p);
        log(`<span style='color:${grade.color}'>[${grade.name}]</span> ${p.name} (ì†ë„:${p.baseSpeed}) íšë“!`);
        updateDisplay();
      } else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }

    function buyShoes() {
      if (coins >= 70) {
        coins -= 70;
        const templateIndex = weightedRandom(shoes);
        const template = shoes[templateIndex];
        const grade = randomGrade();
        const s = JSON.parse(JSON.stringify(template));
        s.grade = grade.name;
        s.gradeColor = grade.color;
        s.baseJump = Math.round(randBetween(template.baseJump[0], template.baseJump[1]) * grade.stat);
        s.upgrade = 0;
        s.options = getRandomOptions(grade.name);
        shoesInventory.push(s);
        log(`<span style='color:${grade.color}'>[${grade.name}]</span> ${s.name} (ì í”„:${s.baseJump}) íšë“!`);
        updateDisplay();
      } else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }

    function buyNecklace() {
      if (coins >= 150) {
        coins -= 150;
        const templateIndex = weightedRandom(necklaces);
        const template = necklaces[templateIndex];
        const grade = randomGrade();
        const n = JSON.parse(JSON.stringify(template));
        n.grade = grade.name;
        n.gradeColor = grade.color;
        n.baseHp = Math.round(randBetween(template.baseHp[0], template.baseHp[1]) * grade.stat);
        n.upgrade = 0;
        n.options = getRandomOptions(grade.name);
        necklaceInventory.push(n);
        log(`<span style='color:${grade.color}'>[${grade.name}]</span> ${n.name} (HP:${n.baseHp}) íšë“!`);
        updateDisplay();
      } else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }

    function buyRing() {
      if (coins >= 110) {
        coins -= 110;
        const templateIndex = weightedRandom(rings);
        const template = rings[templateIndex];
        const grade = randomGrade();
        const r = JSON.parse(JSON.stringify(template));
        r.grade = grade.name;
        r.gradeColor = grade.color;
        r.baseAtk = Math.round(randBetween(template.baseAtk[0], template.baseAtk[1]) * grade.stat);
        r.upgrade = 0;
        r.options = getRandomOptions(grade.name);
        ringInventory.push(r);
        log(`<span style='color:${grade.color}'>[${grade.name}]</span> ${r.name} (ê³µê²©:${r.baseAtk}) íšë“!`);
        updateDisplay();
      } else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }
    let monsterAtkSpd = 1000; // ms
    let autoBattleInterval = null;

    // ìµœê·¼ ë°ë¯¸ì§€ í‘œì‹œìš© ë³€ìˆ˜
    let playerLastDamage = 0;
    let monsterLastDamage = 0;
    let playerDamageTimeout = null;
    let monsterDamageTimeout = null;

    const weapons = [
      { name: "ë¡±ì†Œë“œ", baseDamage: [8, 12], effect: "20% í™•ë¥  2ë°° ë°ë¯¸ì§€", atkSpdRange: [600, 900], icon: "âš”ï¸" },
      { name: "ë„ë¼", baseDamage: [12, 18], effect: "10% í™•ë¥  ì¹˜ëª…íƒ€(3ë°°)", atkSpdRange: [800, 1200], icon: "ğŸª“" },
      { name: "ë‹¨ê²€", baseDamage: [4, 8], effect: "30% í™•ë¥  ì¶”ê°€ê³µê²©", atkSpdRange: [300, 600], icon: "ğŸ—¡ï¸" },
      { name: "ë§ˆë²•ë´‰", baseDamage: [6, 10], effect: "20% í™•ë¥  í˜„ì¬ì²´ë ¥ 10% ì¶”ê°€ë°ë¯¸ì§€", atkSpdRange: [700, 1000], icon: "ğŸª„" },
      { name: "í™œ", baseDamage: [10, 14], effect: "15% í™•ë¥  ë°©ì–´ë¬´ì‹œ", atkSpdRange: [500, 800], icon: "ğŸ¹" }
    ];

    // ëª¬ìŠ¤í„° ì´ë¦„ê³¼ ì´ë¯¸ì§€ ë°ì´í„°
    const monsterTypes = [
      // ì´ˆì›
      [{ name: "ì´ˆë¡ ìŠ¬ë¼ì„", emoji: "ğŸŸ¢" }, { name: "ì•¼ìƒ í† ë¼", emoji: "ğŸ‡" }, { name: "ì´ˆì› ë‹¬íŒ¡ì´", emoji: "ğŸŒ" }],
      // ìˆ²
      [{ name: "ì–´ë‘  ëŠ˜ëŒ€", emoji: "ğŸº" }, { name: "ìˆ² ê³ ë¸”ë¦°", emoji: "ğŸ‘¹" }, { name: "ê±°ëŒ€ ê±°ë¯¸", emoji: "ğŸ•·ï¸" }],
      // ë™êµ´
      [{ name: "ë™êµ´ ë°•ì¥", emoji: "ğŸ¦‡" }, { name: "ì–´ë‘  ì˜¤í¬", emoji: "ğŸ‘¹" }, { name: "ë™êµ´ ë“œë ˆì´í¬", emoji: "ğŸ²" }],
      // í™”ì‚°
      [{ name: "í™”ì—¼ ë°ëª¨", emoji: "ğŸ”¥" }, { name: "ìš©ì•” ê³¨ë ˜", emoji: "ğŸ§Ÿ" }, { name: "í™”ì‚° ë“œë˜ê³¤", emoji: "ğŸ‰" }],
      // ë¹™í•˜
      [{ name: "ì–¼ìŒ ê±°ì¸", emoji: "â„ï¸" }, { name: "ì„œë¦¬ ëŠ‘ëŒ€", emoji: "ğŸº" }, { name: "ë¹™í•˜ ì •ë ¹", emoji: "ğŸ‘»" }, { name: "ëˆˆë³´ë¼ ë“œë˜ê³¤", emoji: "ğŸ²" }],
      // ì‚¬ë§‰
      [{ name: "ì‚¬ë§‰ ì „ê°ˆ", emoji: "ğŸ¦‚" }, { name: "ëª¨ë˜ ë°”ì‹¤ë¦¬ìŠ¤í¬", emoji: "ğŸ" }, { name: "ì‚¬ë§‰ ë‚˜ê°€", emoji: "ğŸ‰" }, { name: "ë¯¸ë¼ ë¡œë“œ", emoji: "ğŸ§Ÿâ€â™‚ï¸" }],
      // ì‹¬ì—°
      [{ name: "ì‹¬ì—° í¬ë¼ì¼„", emoji: "ğŸ™" }, { name: "ì–´ë‘  ì•…ë§ˆ", emoji: "ğŸ˜ˆ" }, { name: "ê³µí—ˆ ìŠ¤í™í„°", emoji: "ğŸ‘»" }, { name: "ì‹¬ì—° ë“œë˜ê³¤", emoji: "ğŸ²" }, { name: "ë¬´ëª… ê³µí¬", emoji: "ğŸ–¤" }],
      // ì²œê³µì„±
      [{ name: "ì²œì‚¬ ì›Œë¦¬ì–´", emoji: "ğŸ‘¼" }, { name: "ë¹›ì˜ ìˆ˜í˜¸ì", emoji: "âœ¨" }, { name: "ëŒ€ì²œì‚¬", emoji: "ğŸ•Šï¸" }, { name: "ì„¸ë¼í•Œ", emoji: "ğŸ‘¼" }, { name: "ì²œê³„ ë“œë˜ê³¤", emoji: "ğŸ‰" }],
      // ì–´ë‘ ì˜ ì˜ì—­
      [{ name: "ê·¸ë¦¼ì ì•…ë§ˆ", emoji: "ğŸ˜ˆ" }, { name: "ì£½ìŒì˜ ê¸°ì‚¬", emoji: "ğŸ’€" }, { name: "ì–´ë‘  êµ°ì£¼", emoji: "ğŸ‘‘" }, { name: "ë„¤í¬ë¡œë§¨ì„œ", emoji: "ğŸ§™â€â™€ï¸" }, { name: "ì•”í‘ ë“œë˜ê³¤", emoji: "ğŸ²" }, { name: "ê³µí—ˆ ì œì™•", emoji: "ğŸ–¤" }],
      // ì‹œê³µì˜ í‹ˆ
      [{ name: "ì‹œê³µ ìˆ˜í˜¸ì", emoji: "â°" }, { name: "ì°¨ì› ì•…ë§ˆ", emoji: "ğŸ‘¹" }, { name: "ë¬´í•œ ë“œë˜ê³¤", emoji: "ğŸŒ€" }, { name: "ì‹œê°„ ì¡°ì‘ì", emoji: "âš¡" }, { name: "ê³µê°„ íŒŒê´´ì", emoji: "ğŸ’¥" }, { name: "ìš´ëª…ì˜ ì£¼ì¸", emoji: "ğŸ”®" }],
      // ì ˆëŒ€ì‹ ì—­
      [{ name: "ì°½ì¡°ì‹ ", emoji: "ğŸŒŸ" }, { name: "íŒŒê´´ì‹ ", emoji: "ğŸ’¥" }, { name: "ì ˆëŒ€ì", emoji: "ğŸ‘‘" }, { name: "ë¬´í•œì‹ ", emoji: "âˆ" }, { name: "ì‹ ì„± ë“œë˜ê³¤", emoji: "ğŸ‰" }, { name: "ì„¸ê³„ìˆ˜ ì •ë ¹", emoji: "ğŸŒ³" }, { name: "ìš°ì£¼ ì§€ë°°ì", emoji: "ğŸŒŒ" }]
    ];

    let logVisible = false;

    function toggleLog() {
      const logDiv = document.getElementById("log");
      const toggleBtn = document.getElementById("logToggle");
      logVisible = !logVisible;
      logDiv.style.display = logVisible ? "block" : "none";
      toggleBtn.textContent = logVisible ? "ë¡œê·¸ ìˆ¨ê¸°ê¸°" : "ë¡œê·¸ ë³´ê¸°";
    }

    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.innerHTML = msg + "<br>" + logDiv.innerHTML;
    }

    function battleLog(msg) {
      const battleLogDiv = document.getElementById("battleLog");
      battleLogDiv.innerHTML = msg + "<br>" + battleLogDiv.innerHTML;
    }

    function showBattleInfo(msg, duration = 2000) {
      const battleInfo = document.getElementById("battleInfo");
      battleInfo.textContent = msg;
      battleInfo.classList.add("show");
      setTimeout(() => {
        battleInfo.classList.remove("show");
      }, duration);
    }

    function showDamagePopup(element, damage, type = 'damage') {
      const popup = document.createElement('div');
      popup.className = `damage-popup ${type}`;
      if(damage==undefined || isNaN(damage)){
        damage=0;
      }
      popup.textContent = type === 'gold' ? `+${Math.floor(damage)} ê³¨ë“œ` : `-${Math.floor(damage)}`;

      element.style.position = 'relative';
      element.appendChild(popup);

      setTimeout(() => {
        if (popup.parentNode) {
          popup.parentNode.removeChild(popup);
        }
      }, 1000);
    }

    // ëª¬ìŠ¤í„° ì „ìš© ë°ë¯¸ì§€ íŒì—… í•¨ìˆ˜
    function showMonsterDamagePopup(monsterId, damage, type = 'damage') {
      console.log(`Trying to show damage popup for monster${monsterId}, damage: ${damage}`);
      const monsterElement = document.getElementById(`monster${monsterId}`);
      if (!monsterElement) {
        console.log(`Monster element not found: monster${monsterId}`);
        // ëª¨ë“  ëª¬ìŠ¤í„° ìš”ì†Œ í™•ì¸
        const allMonsters = document.querySelectorAll('[id^="monster"]');
        console.log('Available monster elements:', Array.from(allMonsters).map(el => el.id));
        return;
      }
      console.log(`Found monster element: ${monsterElement.id}`);

      const popup = document.createElement('div');
      popup.className = `damage-popup ${type}`;
      popup.style.cssText = `
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translate(-50%, 0);
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-weight: bold;
        font-size: 12px;
        pointer-events: none;
        z-index: 9999;
        animation: damageFloatMonster 1s ease-out forwards;
        white-space: nowrap;
      `;

      if (type === 'heal') {
        popup.style.background = 'rgba(0, 255, 0, 0.9)';
      }

      if(damage==undefined || isNaN(damage)){
        damage=0;
      }
      popup.textContent = type === 'heal' ? `+${Math.floor(damage)}` : `-${Math.floor(damage)}`;

      monsterElement.style.position = 'relative';
      monsterElement.appendChild(popup);

      setTimeout(() => {
        if (popup.parentNode) {
          popup.parentNode.removeChild(popup);
        }
      }, 1000);
    }

    function updateUIVisibility() {
      const shopDiv = document.getElementById("shop");
      const battleAreaDiv = document.querySelector(".battle-area");
      const battleLogDiv = document.getElementById("battleLog");
      const fieldSelectDiv = document.getElementById("fieldSelect");
      // ìë™ì‚¬ëƒ¥ì´ ONì´ë©´ ì‚¬ëƒ¥ ì¤‘ìœ¼ë¡œ ê°„ì£¼ (ëª¬ìŠ¤í„° ë¦¬ìŠ¤í° ëŒ€ê¸° ì‹œê°„ì—ë„ ìƒì  ìˆ¨ê¹€)
      const isHunting = autoHunt && player.alive;

      if (isHunting) {
        // ì‚¬ëƒ¥ ì¤‘: ìƒì  ìˆ¨ê¹€, ì‚¬ëƒ¥í„° UI ë³´ì„
        shopDiv.classList.add("hidden");
        battleAreaDiv.classList.remove("hidden");
        battleLogDiv.classList.remove("hidden");
        fieldSelectDiv.classList.remove("hidden");
      } else {
        // ë¹„ì‚¬ëƒ¥ ì¤‘: ìƒì  ë³´ì„, ì‚¬ëƒ¥í„° UI ìˆ¨ê¹€ (ìë™ì‚¬ëƒ¥ ë²„íŠ¼ì€ í•­ìƒ ë³´ì„)
        shopDiv.classList.remove("hidden");
        battleAreaDiv.classList.add("hidden");
        battleLogDiv.classList.add("hidden");
        fieldSelectDiv.classList.add("hidden");
      }
    }

    function updateDisplay() {
      document.getElementById("coins").textContent = coins;
      document.getElementById("gems").textContent = gems;
      document.getElementById("killCount").textContent = totalMonstersKilled;

      // ì§„í–‰ ìƒí™© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      const progressMsg = document.getElementById("progressMessage");

      // ë‹¤ìŒ í•´ê¸ˆë  ì‚¬ëƒ¥í„° ì°¾ê¸°
      let nextField = null;
      for (let i = 0; i < fields.length; i++) {
        if (totalMonstersKilled < fields[i].unlock) {
          nextField = fields[i];
          break;
        }
      }

      if (totalMonstersKilled < 20) {
        progressMsg.textContent = `(${20 - totalMonstersKilled}ë§ˆë¦¬ ë” ì²˜ì¹˜í•˜ë©´ ë‹¤ì¤‘ ëª¬ìŠ¤í„° ë“±ì¥!)`;
        progressMsg.style.color = "#fa4";
      } else if (nextField) {
        const remaining = nextField.unlock - totalMonstersKilled;
        progressMsg.textContent = `(${remaining}ë§ˆë¦¬ ë” ì²˜ì¹˜í•˜ë©´ [${nextField.name}] í•´ê¸ˆ!)`;
        progressMsg.style.color = "#4af";
      } else {
        progressMsg.textContent = "(ëª¨ë“  ì‚¬ëƒ¥í„° í•´ê¸ˆ ì™„ë£Œ! ìµœê³  ë ˆë²¨!)";
        progressMsg.style.color = "#f84";
      }

      updateUIVisibility();
      const invDiv = document.getElementById("inventoryList");

      let html = "";

      // ì¥ì°© ì¤‘ì¸ ì•„ì´í…œ ì„¹ì…˜
      html += `<div class="equipped-section">`;
      html += `<div class="equipped-title">âœ¨ ì¥ì°© ì¤‘ âœ¨</div>`;

      if (equipped !== null && inventory[equipped]) {
        const w = inventory[equipped];
        const totalDamage = w.baseDamage + (w.upgrade || 0) * 2 + player.bonusAtk;
        const dps = Math.round((totalDamage / w.atkSpd) * 1000 * 10) / 10;
        html += `<div><strong>ë¬´ê¸°:</strong> <span class="${weaponClass(w.upgrade)}">${w.name} +${w.upgrade}</span> (ê³µ:${totalDamage}, DPS:${dps}) `;
        html += `<button class="sell-btn" onclick="equipped=null; updateDisplay();" style="margin-left:5px; font-size:10px;">í•´ì œ</button></div>`;
        if (w.options && w.options.length > 0) {
          w.options.forEach(option => {
            let optionColor = option.isUnique ? '#ffd700' : '#6cf'; // ìœ ë‹ˆí¬ ì˜µì…˜ì€ í™©ê¸ˆìƒ‰
            html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
          });
        }
      } else {
        html += `<div><strong>ë¬´ê¸°:</strong> ì—†ìŒ</div>`;
      }

      if (equippedArmor !== null && armorInventory[equippedArmor]) {
        const a = armorInventory[equippedArmor];
        const totalDef = a.baseDef + (a.upgrade || 0) * 2;
        html += `<div><strong>ë°©ì–´êµ¬:</strong> <span style='color:#6cf;'>${a.name} +${a.upgrade}</span> (ë°©ì–´:${totalDef}) `;
        html += `<button class="sell-btn" onclick="equippedArmor=null; updateDisplay();" style="margin-left:5px; font-size:10px;">í•´ì œ</button></div>`;
        if (a.options && a.options.length > 0) {
          a.options.forEach(option => {
            let optionColor = option.isUnique ? '#ffd700' : '#6cf';
            html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
          });
        }
      } else {
        html += `<div><strong>ë°©ì–´êµ¬:</strong> ì—†ìŒ</div>`;
      }

      if (equippedHelmet !== null && helmetInventory[equippedHelmet]) {
        const h = helmetInventory[equippedHelmet];
        const totalDodge = Math.min(h.baseDodge + (h.upgrade || 0) * 2, 75);
        html += `<div><strong>ëª¨ì:</strong> <span style='color:#f84;'>${h.name} +${h.upgrade}</span> (íšŒí”¼:${totalDodge}%) `;
        html += `<button class="sell-btn" onclick="equippedHelmet=null; updateDisplay();" style="margin-left:5px; font-size:10px;">í•´ì œ</button></div>`;
        if (h.options && h.options.length > 0) {
          h.options.forEach(option => {
            let optionColor = option.isUnique ? '#ffd700' : '#6cf';
            html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
          });
        }
      }
      if (equippedPants !== null && pantsInventory[equippedPants]) {
        const p = pantsInventory[equippedPants];
        const totalSpeed = p.baseSpeed + (p.upgrade || 0) * 2;
        html += `<div><strong>ë°”ì§€:</strong> <span style='color:#8f4;'>${p.name} +${p.upgrade}</span> (ì†ë„:${totalSpeed}) `;
        html += `<button class="sell-btn" onclick="equippedPants=null; updateDisplay();" style="margin-left:5px; font-size:10px;">í•´ì œ</button></div>`;
        if (p.options && p.options.length > 0) {
          p.options.forEach(option => {
            let optionColor = option.isUnique ? '#ffd700' : '#6cf';
            html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
          });
        }
      }
      if (equippedShoes !== null && shoesInventory[equippedShoes]) {
        const s = shoesInventory[equippedShoes];
        const totalJump = s.baseJump + (s.upgrade || 0) * 2;
        html += `<div><strong>ì‹ ë°œ:</strong> <span style='color:#48f;'>${s.name} +${s.upgrade}</span> (ì í”„:${totalJump}) `;
        html += `<button class="sell-btn" onclick="equippedShoes=null; updateDisplay();" style="margin-left:5px; font-size:10px;">í•´ì œ</button></div>`;
        if (s.options && s.options.length > 0) {
          s.options.forEach(option => {
            let optionColor = option.isUnique ? '#ffd700' : '#6cf';
            html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
          });
        }
      }
      if (equippedNecklace !== null && necklaceInventory[equippedNecklace]) {
        const n = necklaceInventory[equippedNecklace];
        const totalHp = n.baseHp + (n.upgrade || 0) * 5;
        html += `<div><strong>ëª©ê±¸ì´:</strong> <span style='color:#f48;'>${n.name} +${n.upgrade}</span> (HP:${totalHp}) `;
        html += `<button class="sell-btn" onclick="equippedNecklace=null; updateDisplay();" style="margin-left:5px; font-size:10px;">í•´ì œ</button></div>`;
        if (n.options && n.options.length > 0) {
          n.options.forEach(option => {
            let optionColor = option.isUnique ? '#ffd700' : '#6cf';
            html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
          });
        }
      }
      if (equippedRing !== null && ringInventory[equippedRing]) {
        const r = ringInventory[equippedRing];
        const totalAtk = r.baseAtk + (r.upgrade || 0) * 2;
        html += `<div><strong>ë°˜ì§€:</strong> <span style='color:#f84;'>${r.name} +${r.upgrade}</span> (ê³µê²©:${totalAtk}) `;
        html += `<button class="sell-btn" onclick="equippedRing=null; updateDisplay();" style="margin-left:5px; font-size:10px;">í•´ì œ</button></div>`;
        if (r.options && r.options.length > 0) {
          r.options.forEach(option => {
            let optionColor = option.isUnique ? '#ffd700' : '#6cf';
            html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
          });
        }
      }
      html += `</div>`;

      // í†µí•© ì¸ë²¤í† ë¦¬
      const allItems = [];

      // ë¬´ê¸° ì¶”ê°€ (ë¯¸ì¥ì°©ë§Œ)
      inventory.forEach((w, i) => {
        const isEquipped = (equipped === i);
        if (!isEquipped) {
          const totalDamage = w.baseDamage + (w.upgrade || 0) * 2;
          const dps = Math.round((totalDamage / w.atkSpd) * 1000 * 10) / 10;
          allItems.push({
            type: 'weapon',
            typeOrder: 1,
            typeName: 'ë¬´ê¸°',
            name: w.name,
            upgrade: w.upgrade || 0,
            color: weaponClass(w.upgrade),
            stat1: totalDamage,
            stat2: w.atkSpd + 'ms',
            stat3: dps,
            isEquipped: false,
            equipFunc: `equip(${i})`,
            sellFunc: `sell(${i})`,
            upgradeFunc: `upgrade(${i},'weapon')`,
            grade: w.grade,
            gradeColor: w.gradeColor,
            options: w.options,
          });
        }
      });

      // ë°©ì–´êµ¬ ì¶”ê°€ (ë¯¸ì¥ì°©ë§Œ)
      armorInventory.forEach((a, i) => {
        const isEquipped = (equippedArmor === i);
        if (!isEquipped) {
          const totalDef = a.baseDef + (a.upgrade || 0) * 2;
          allItems.push({
            type: 'armor',
            typeOrder: 2,
            typeName: 'ë°©ì–´êµ¬',
            name: a.name,
            upgrade: a.upgrade || 0,
            color: '',
            stat1: totalDef,
            stat2: '',
            stat3: '',
            isEquipped: false,
            equipFunc: `equipArmor(${i})`,
            sellFunc: `sellArmor(${i})`,
            upgradeFunc: `upgrade(${i},'armor')`,
            grade: a.grade,
            gradeColor: a.gradeColor,
            options: a.options,
          });
        }
      });

      // ê¸°íƒ€ ì¥ë¹„ ì¶”ê°€
      const equipTypes = [
        { inventory: helmetInventory, name: 'ëª¨ì', stat: 'baseDodge', color: '#f84', type: 'helmet', order: 3 },
        { inventory: pantsInventory, name: 'ë°”ì§€', stat: 'baseSpeed', color: '#8f4', type: 'pants', order: 4 },
        { inventory: shoesInventory, name: 'ì‹ ë°œ', stat: 'baseJump', color: '#48f', type: 'shoes', order: 5 },
        { inventory: necklaceInventory, name: 'ëª©ê±¸ì´', stat: 'baseHp', color: '#f48', type: 'necklace', order: 6 },
        { inventory: ringInventory, name: 'ë°˜ì§€', stat: 'baseAtk', color: '#f84', type: 'ring', order: 7 }
      ];

      equipTypes.forEach(equipType => {
        equipType.inventory.forEach((item, i) => {
          const isEquipped = (eval(`equipped${equipType.type.charAt(0).toUpperCase() + equipType.type.slice(1)}`) === i);
          if (!isEquipped) {
            let totalStat = item[equipType.stat] + (item.upgrade || 0) * (equipType.type === 'necklace' ? 5 : equipType.type === 'helmet' ? 2 : 2);
            if (equipType.type === 'helmet') {
              totalStat = Math.min(totalStat, 75);
            }
            allItems.push({
              type: equipType.type,
              typeOrder: equipType.order,
              typeName: equipType.name,
              name: item.name,
              upgrade: item.upgrade || 0,
              color: equipType.color,
              stat1: totalStat,
              stat2: '',
              stat3: '',
              isEquipped: false,
              equipFunc: `equip${equipType.type.charAt(0).toUpperCase() + equipType.type.slice(1)}(${i})`,
              sellFunc: `sell${equipType.type.charAt(0).toUpperCase() + equipType.type.slice(1)}(${i})`,
              upgradeFunc: `upgrade(${i},'${equipType.type}')`,
              grade: item.grade,
              gradeColor: item.gradeColor,
              options: item.options,
            });
          }
        });
      });

      // ì¥ë¹„ íƒ€ì…ë³„ë¡œ ì •ë ¬ (ëª¨ë“  ì•„ì´í…œì´ ë¯¸ì¥ì°©ì´ë¯€ë¡œ isEquipped ì •ë ¬ ì‚­ì œ)
      allItems.sort((a, b) => {
        if (a.typeOrder !== b.typeOrder) return a.typeOrder - b.typeOrder;
        return b.upgrade - a.upgrade; // ê°•í™” ë ˆë²¨ ë†’ì€ ìˆœ
      });

      // í†µí•© ì¸ë²¤í† ë¦¬ í…Œì´ë¸” ìƒì„±
      if (allItems.length > 0) {
        html += `<h3>ì „ì²´ ì¸ë²¤í† ë¦¬</h3>`;
        html += `<div style="margin-bottom: 10px;">`;
        html += `<button onclick="sellAllItems()" style="background: #d44; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ—‘ï¸ ì „ì²´ íŒë§¤ (ì¥ì°© ì¤‘ ì œì™¸)</button>`;
        html += `</div>`;
        html += `<table class="inventory-table">`;
        html += `<tr><th>ì¢…ë¥˜</th><th>ë“±ê¸‰</th><th>ì´ë¦„</th><th>ì£¼ ìŠ¤íƒ¯</th><th>ëŒ€ë¯¸ì§€/ì†ë„</th><th>DPS</th><th style="min-width: 140px;">ì•¡ì…˜</th></tr>`;

        allItems.forEach(item => {
          html += `<tr>`;
          html += `<td>${item.typeName}</td>`;
          html += `<td><span style='color:${item.gradeColor || "#888"};font-weight:bold;'>${item.grade || "ì¼ë°˜"}</span></td>`;
          let nameClass = item.type === 'weapon' ? item.color : '';
          let nameStyle = item.type !== 'weapon' && item.type !== 'armor' ? item.color : (item.type === 'armor' ? '#6cf' : '');
          html += `<td><span class="item-name ${nameClass}" ${nameStyle ? `style=\"color:${nameStyle};\"` : ''}>`;
          html += `${item.name} +${item.upgrade}`;
          if (item.options && item.options.length > 0) {
            item.options.forEach(option => {
              let optionColor = option.isUnique ? '#ffd700' : '#6cf';
              html += `<div style='font-size:11px;color:${optionColor};${option.isUnique ? 'font-weight:bold;text-shadow:0 0 3px #ffd700;' : ''}'>${option.key}</div>`;
            });
          }
          html += `</span></td>`;
          html += `<td>${item.stat1}</td>`;
          html += `<td>${item.stat2}</td>`;
          html += `<td>${item.stat3}</td>`;
          html += `<td style="white-space: nowrap;">`;
          html += `<button class="equip-btn" onclick="${item.equipFunc}">ì°©ìš©</button>`;
          html += `<button class="sell-btn" onclick="${item.sellFunc}">íŒë§¤</button>`;
          html += `<button class="upgrade-btn" onclick="${item.upgradeFunc}">ê°•í™”</button>`;
          html += `</td></tr>`;
        });
        html += `</table>`;
      }

      invDiv.innerHTML = html;
      updatePlayerArea();
      updateMonstersDisplay();
      updateFieldSelect();
      updateCharacterSprite();
      updatePlayerStats();
      updateUIVisibility();
    }

    function updateCharacterSprite() {
      const sprite = document.getElementById("characterSprite");
      const weaponIcon = document.getElementById("weaponIcon");

      if (equipped !== null && inventory[equipped]) {
        const weapon = inventory[equipped];
        weaponIcon.textContent = weapon.icon || "âš”ï¸";
        weaponIcon.style.display = "flex";
      } else {
        weaponIcon.style.display = "none";
      }
    }

    function updatePlayerArea() {
      const area = document.getElementById("playerArea");
      const currentMaxHp = player.maxHp + player.bonusHp;
      const percent = Math.max(0, Math.round(player.hp / currentMaxHp * 100));
      let damagePercent = 0;
      if (playerLastDamage > 0) {
        damagePercent = Math.min(100, Math.round(playerLastDamage / currentMaxHp * 100));
        if (percent + damagePercent > 100) damagePercent = 100 - percent;
      }
      area.innerHTML = `HP: ${Math.floor(player.hp)}/${currentMaxHp}` +
        (player.def > 0 ? ` / ë°©ì–´: ${player.def}` : "") +
        (player.bonusAtk > 0 ? ` / +ê³µê²©: ${player.bonusAtk}` : "") +
        (player.dodge > 0 ? ` / íšŒí”¼: ${player.dodge}%` : "") +
        `<div style='background:#444;width:100%;height:18px;border-radius:8px;margin:4px 0;position:relative;overflow:hidden;'>` +
        `<div style='background:#4af;height:100%;width:${percent}%;border-radius:8px;transition:width 0.2s;position:absolute;left:0;top:0;'></div>` +
        (damagePercent > 0 ? `<div style='background:#fff;opacity:0.7;height:100%;width:${damagePercent}%;border-radius:8px;position:absolute;left:${percent}%;top:0;transition:width 0.2s;'></div>` : "") +
        `</div>`;
    }

    function updatePlayerStats() {
      // ëª¨ë“  ì¥ë¹„ì˜ ì˜µì…˜ íš¨ê³¼ ê³„ì‚°
      let totalOptionStats = {
        atk: 0,
        def: 0,
        hp: 0,
        dodge: 0,
        speed: 0,
        jump: 0
      };

      // ê° ì¥ë¹„ì˜ ì˜µì…˜ íš¨ê³¼ í•©ì‚°
      if (equipped !== null && inventory[equipped]) {
        let weaponStats = getItemOptionStats(inventory[equipped]);
        Object.keys(weaponStats).forEach(key => {
          totalOptionStats[key] += weaponStats[key];
        });
      }

      if (equippedArmor !== null && armorInventory[equippedArmor]) {
        let armorStats = getItemOptionStats(armorInventory[equippedArmor]);
        Object.keys(armorStats).forEach(key => {
          totalOptionStats[key] += armorStats[key];
        });
      }

      if (equippedHelmet !== null && helmetInventory[equippedHelmet]) {
        let helmetStats = getItemOptionStats(helmetInventory[equippedHelmet]);
        Object.keys(helmetStats).forEach(key => {
          totalOptionStats[key] += helmetStats[key];
        });
      }

      if (equippedPants !== null && pantsInventory[equippedPants]) {
        let pantsStats = getItemOptionStats(pantsInventory[equippedPants]);
        Object.keys(pantsStats).forEach(key => {
          totalOptionStats[key] += pantsStats[key];
        });
      }

      if (equippedShoes !== null && shoesInventory[equippedShoes]) {
        let shoesStats = getItemOptionStats(shoesInventory[equippedShoes]);
        Object.keys(shoesStats).forEach(key => {
          totalOptionStats[key] += shoesStats[key];
        });
      }

      if (equippedNecklace !== null && necklaceInventory[equippedNecklace]) {
        let necklaceStats = getItemOptionStats(necklaceInventory[equippedNecklace]);
        Object.keys(necklaceStats).forEach(key => {
          totalOptionStats[key] += necklaceStats[key];
        });
      }

      if (equippedRing !== null && ringInventory[equippedRing]) {
        let ringStats = getItemOptionStats(ringInventory[equippedRing]);
        Object.keys(ringStats).forEach(key => {
          totalOptionStats[key] += ringStats[key];
        });
      }

      // ì²´ë ¥ ì—…ë°ì´íŠ¸ (ëª©ê±¸ì´ ê¸°ë³¸ HP + ì˜µì…˜ HP)
      const oldMaxHp = player.maxHp + player.bonusHp;
      let baseNecklaceHp = equippedNecklace !== null ? necklaceInventory[equippedNecklace].baseHp + (necklaceInventory[equippedNecklace].upgrade || 0) * 5 : 0;
      player.bonusHp = baseNecklaceHp + totalOptionStats.hp;
      const newMaxHp = player.maxHp + player.bonusHp;

      if (newMaxHp > oldMaxHp) {
        // ì²´ë ¥ ì¦ê°€ì‹œ í˜„ì¬ HPë„ ì¦ê°€
        player.hp += (newMaxHp - oldMaxHp);
      } else if (newMaxHp < oldMaxHp) {
        // ì²´ë ¥ ê°ì†Œì‹œ ìµœëŒ€ ì²´ë ¥ì„ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ì¡°ì •
        if (player.hp > newMaxHp) player.hp = newMaxHp;
      }

      // ì²´ë ¥ì´ ìµœëŒ€ì²´ë ¥ì„ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ë³´ì¥
      if (player.hp > newMaxHp) player.hp = newMaxHp;

      // ë°©ì–´ë ¥ (ê°‘ì˜· ê¸°ë³¸ ë°©ì–´ë ¥ + ì˜µì…˜ ë°©ì–´ë ¥)
      let baseArmorDef = (equippedArmor !== null ? armorInventory[equippedArmor].baseDef + (armorInventory[equippedArmor].upgrade || 0) * 2 : 0);
      player.def = baseArmorDef + totalOptionStats.def;

      // íšŒí”¼ìœ¨ ê³„ì‚° (ìµœëŒ€ 75%ê¹Œì§€, ëª¨ì ê¸°ë³¸ íšŒí”¼ + ì˜µì…˜ íšŒí”¼)
      let baseHelmetDodge = (equippedHelmet !== null ? helmetInventory[equippedHelmet].baseDodge + (helmetInventory[equippedHelmet].upgrade || 0) * 2 : 0);
      let rawDodge = baseHelmetDodge + totalOptionStats.dodge;
      player.dodge = Math.min(rawDodge, 75);

      // ì´ë™ì†ë„ (ë°”ì§€ ê¸°ë³¸ ì†ë„ + ì˜µì…˜ ì†ë„)
      let basePantsSpeed = (equippedPants !== null ? pantsInventory[equippedPants].baseSpeed + (pantsInventory[equippedPants].upgrade || 0) * 2 : 0);
      player.speed = basePantsSpeed + totalOptionStats.speed;

      // ì í”„ë ¥ (ì‹ ë°œ ê¸°ë³¸ ì í”„ + ì˜µì…˜ ì í”„)
      let baseShoesJump = (equippedShoes !== null ? shoesInventory[equippedShoes].baseJump + (shoesInventory[equippedShoes].upgrade || 0) * 2 : 0);
      player.jump = baseShoesJump + totalOptionStats.jump;

      // ì¶”ê°€ ê³µê²©ë ¥ (ë°˜ì§€ ê¸°ë³¸ ê³µê²© + ì˜µì…˜ ê³µê²©)
      let baseRingAtk = (equippedRing !== null ? ringInventory[equippedRing].baseAtk + (ringInventory[equippedRing].upgrade || 0) * 2 : 0);
      player.bonusAtk = baseRingAtk + totalOptionStats.atk;

      // í¼ì„¼íŠ¸ ì¦ê°€ ìŠ¤íƒ¯ ì ìš©
      applyPercentageStats();
    }

    // í¼ì„¼íŠ¸ ì¦ê°€ ìŠ¤íƒ¯ ì ìš© í•¨ìˆ˜
    function applyPercentageStats() {
      // ëª¨ë“  ì¥ì°©ëœ ì•„ì´í…œì˜ ìœ ë‹ˆí¬ í¼ì„¼íŠ¸ ì˜µì…˜ í™•ì¸
      const allEquippedItems = [
        equipped !== null ? inventory[equipped] : null,
        equippedArmor !== null ? armorInventory[equippedArmor] : null,
        equippedHelmet !== null ? helmetInventory[equippedHelmet] : null,
        equippedPants !== null ? pantsInventory[equippedPants] : null,
        equippedShoes !== null ? shoesInventory[equippedShoes] : null,
        equippedNecklace !== null ? necklaceInventory[equippedNecklace] : null,
        equippedRing !== null ? ringInventory[equippedRing] : null
      ].filter(item => item !== null);

      let percentStats = {
        attack_percent: 0,
        defense_percent: 0,
        hp_percent: 0,
        speed_percent: 0
      };

      allEquippedItems.forEach(item => {
        if (item.options) {
          item.options.forEach(option => {
            if (option.isUnique && option.category === 'percentage_stats') {
              if (percentStats.hasOwnProperty(option.type)) {
                percentStats[option.type] += option.value;
              }
            }
          });
        }
      });

      // ê³µê²©ë ¥ í¼ì„¼íŠ¸ ì¦ê°€ ì ìš©
      if (percentStats.attack_percent > 0) {
        player.bonusAtk = Math.floor(player.bonusAtk * (1 + percentStats.attack_percent / 100));
      }

      // ë°©ì–´ë ¥ í¼ì„¼íŠ¸ ì¦ê°€ ì ìš©
      if (percentStats.defense_percent > 0) {
        player.def = Math.floor(player.def * (1 + percentStats.defense_percent / 100));
      }

      // ì²´ë ¥ í¼ì„¼íŠ¸ ì¦ê°€ ì ìš©
      if (percentStats.hp_percent > 0) {
        let oldMaxHp = player.maxHp + player.bonusHp;
        let percentBonus = Math.floor((player.maxHp + player.bonusHp) * percentStats.hp_percent / 100);
        player.bonusHp += percentBonus;
        let newMaxHp = player.maxHp + player.bonusHp;

        // ì²´ë ¥ ì¦ê°€ë§Œí¼ í˜„ì¬ ì²´ë ¥ë„ ì¦ê°€
        if (newMaxHp > oldMaxHp) {
          player.hp += (newMaxHp - oldMaxHp);
        }
      }

      // ê³µê²© ì†ë„ í¼ì„¼íŠ¸ ì¦ê°€ëŠ” startAutoBattleì—ì„œ ì ìš©
    }

    function equipArmor(i) {
      if (equippedArmor === i) {
        equippedArmor = null;
        log("ë°©ì–´êµ¬ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      } else {
        equippedArmor = i;
        log(armorInventory[i].name + " ì°©ìš©!");
      }
      updateDisplay();
    }

    function equipHelmet(i) {
      if (equippedHelmet === i) {
        equippedHelmet = null;
        log("ëª¨ìë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      } else {
        equippedHelmet = i;
        log(helmetInventory[i].name + " ì°©ìš©!");
      }
      updateDisplay();
    }

    function equipPants(i) {
      if (equippedPants === i) {
        equippedPants = null;
        log("ë°”ì§€ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      } else {
        equippedPants = i;
        log(pantsInventory[i].name + " ì°©ìš©!");
      }
      updateDisplay();
    }

    function equipShoes(i) {
      if (equippedShoes === i) {
        equippedShoes = null;
        log("ì‹ ë°œì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      } else {
        equippedShoes = i;
        log(shoesInventory[i].name + " ì°©ìš©!");
      }
      updateDisplay();
    }

    function equipNecklace(i) {
      if (equippedNecklace === i) {
        equippedNecklace = null;
        log("ëª©ê±¸ì´ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      } else {
        const oldMaxHp = player.maxHp + player.bonusHp;
        equippedNecklace = i;
        updatePlayerStats(); // ìŠ¤í…œ ë¨¼ì € ì—…ë°ì´íŠ¸
        const newMaxHp = player.maxHp + player.bonusHp;

        // ì²´ë ¥ì´ ìµœëŒ€ì²´ë ¥ë³´ë‹¤ ë‚®ìœ¼ë©´ ìµœëŒ€ì²´ë ¥ê¹Œì§€ ì±„ì›Œì¤Œ
        if (player.hp < newMaxHp) {
          player.hp = newMaxHp;
        }

        log(necklaceInventory[i].name + " ì°©ìš©! ì²´ë ¥ì´ ìµœëŒ€ì¹˜ë¡œ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
      updateDisplay();
    }

    function equipRing(i) {
      if (equippedRing === i) {
        equippedRing = null;
        log("ë°˜ì§€ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.");
      } else {
        equippedRing = i;
        log(ringInventory[i].name + " ì°©ìš©!");
      }
      updateDisplay();
    }
    function sellArmor(i) {
      let a = armorInventory[i];
      let value = 60; // ë°©ì–´êµ¬ êµ¬ë§¤ê°€ê²©(120ì½”ì¸)ì˜ ë°˜ê°’
      coins += value;
      log(`${a.name} íŒë§¤í•˜ì—¬ ${value}ì½”ì¸ íšë“`);

      // ì¥ì°©ëœ ë°©ì–´êµ¬ ì¸ë±ìŠ¤ ì¡°ì •
      if (equippedArmor === i) {
        equippedArmor = null;
      } else if (equippedArmor !== null && equippedArmor > i) {
        equippedArmor--;
      }

      armorInventory.splice(i, 1);
      updateDisplay();
    }

    function sellHelmet(i) {
      let h = helmetInventory[i];
      let value = 40; // ëª¨ì êµ¬ë§¤ê°€ê²©(80ì½”ì¸)ì˜ ë°˜ê°’
      coins += value;
      log(`${h.name} íŒë§¤í•˜ì—¬ ${value}ì½”ì¸ íšë“`);

      // ì¥ì°©ëœ ëª¨ì ì¸ë±ìŠ¤ ì¡°ì •
      if (equippedHelmet === i) {
        equippedHelmet = null;
      } else if (equippedHelmet !== null && equippedHelmet > i) {
        equippedHelmet--;
      }

      helmetInventory.splice(i, 1);
      updateDisplay();
    }

    function sellPants(i) {
      let p = pantsInventory[i];
      let value = 45; // ë°”ì§€ êµ¬ë§¤ê°€ê²©(90ì½”ì¸)ì˜ ë°˜ê°’
      coins += value;
      log(`${p.name} íŒë§¤í•˜ì—¬ ${value}ì½”ì¸ íšë“`);

      // ì¥ì°©ëœ ë°”ì§€ ì¸ë±ìŠ¤ ì¡°ì •
      if (equippedPants === i) {
        equippedPants = null;
      } else if (equippedPants !== null && equippedPants > i) {
        equippedPants--;
      }

      pantsInventory.splice(i, 1);
      updateDisplay();
    }

    function sellShoes(i) {
      let s = shoesInventory[i];
      let value = 35; // ì‹ ë°œ êµ¬ë§¤ê°€ê²©(70ì½”ì¸)ì˜ ë°˜ê°’
      coins += value;
      log(`${s.name} íŒë§¤í•˜ì—¬ ${value}ì½”ì¸ íšë“`);

      // ì¥ì°©ëœ ì‹ ë°œ ì¸ë±ìŠ¤ ì¡°ì •
      if (equippedShoes === i) {
        equippedShoes = null;
      } else if (equippedShoes !== null && equippedShoes > i) {
        equippedShoes--;
      }

      shoesInventory.splice(i, 1);
      updateDisplay();
    }

    function sellNecklace(i) {
      let n = necklaceInventory[i];
      let value = 75; // ëª©ê±¸ì´ êµ¬ë§¤ê°€ê²©(150ì½”ì¸)ì˜ ë°˜ê°’
      coins += value;
      log(`${n.name} íŒë§¤í•˜ì—¬ ${value}ì½”ì¸ íšë“`);

      // ì¥ì°©ëœ ëª©ê±¸ì´ ì¸ë±ìŠ¤ ì¡°ì •
      if (equippedNecklace === i) {
        equippedNecklace = null;
      } else if (equippedNecklace !== null && equippedNecklace > i) {
        equippedNecklace--;
      }

      necklaceInventory.splice(i, 1);
      updateDisplay();
    }

    function sellRing(i) {
      let r = ringInventory[i];
      let value = 55; // ë°˜ì§€ êµ¬ë§¤ê°€ê²©(110ì½”ì¸)ì˜ ë°˜ê°’
      coins += value;
      log(`${r.name} íŒë§¤í•˜ì—¬ ${value}ì½”ì¸ íšë“`);

      // ì¥ì°©ëœ ë°˜ì§€ ì¸ë±ìŠ¤ ì¡°ì •
      if (equippedRing === i) {
        equippedRing = null;
      } else if (equippedRing !== null && equippedRing > i) {
        equippedRing--;
      }

      ringInventory.splice(i, 1);
      updateDisplay();
    }

    // ë“±ê¸‰ ì •ì˜
    const ITEM_GRADES = [
      { name: "ì¼ë°˜", color: "#ccc", rate: 0.7, stat: 1 },
      { name: "ë§¤ì§", color: "#4af", rate: 0.2, stat: 1.2 },
      { name: "ë ˆì–´", color: "#a4f", rate: 0.09, stat: 1.5 },
      { name: "ìœ ë‹ˆí¬", color: "gold", rate: 0.01, stat: 2 }
    ];
    function randomGrade() {
      // ì‚¬ëƒ¥í„°ì— ë”°ë¥¸ ë“±ê¸‰ í™•ë¥  ì¡°ì •
      let grades = JSON.parse(JSON.stringify(ITEM_GRADES)); // ê¹Šì€ ë³µì‚¬

      if (currentField >= 4) { // ë¹™í•˜ ì´ìƒ
        grades[0].rate = Math.max(0.3, grades[0].rate - (currentField - 3) * 0.08); // ì¼ë°˜ í™•ë¥  ê°ì†Œ
        grades[1].rate = Math.min(0.4, grades[1].rate + (currentField - 3) * 0.03); // ë§¤ì§ í™•ë¥  ì¦ê°€
        grades[2].rate = Math.min(0.25, grades[2].rate + (currentField - 3) * 0.03); // ë ˆì–´ í™•ë¥  ì¦ê°€
        grades[3].rate = Math.min(0.15, grades[3].rate + (currentField - 3) * 0.02); // ìœ ë‹ˆí¬ í™•ë¥  ì¦ê°€
      }

      if (currentField >= 8) { // ì²œê³µì„± ì´ìƒ - ì¶”ê°€ ë³´ë„ˆìŠ¤
        grades[0].rate = Math.max(0.1, grades[0].rate - 0.2);
        grades[1].rate = Math.min(0.5, grades[1].rate + 0.05);
        grades[2].rate = Math.min(0.3, grades[2].rate + 0.1);
        grades[3].rate = Math.min(0.25, grades[3].rate + 0.05);
      }

      if (currentField >= 10) { // ì ˆëŒ€ì‹ ì—­ - ìµœê³  ë³´ë„ˆìŠ¤
        grades[0].rate = 0.05; // ì¼ë°˜ 5%
        grades[1].rate = 0.35; // ë§¤ì§ 35%
        grades[2].rate = 0.4;  // ë ˆì–´ 40%
        grades[3].rate = 0.2;  // ìœ ë‹ˆí¬ 20%
      }

      const r = Math.random();
      let acc = 0;
      for (let g of grades) {
        acc += g.rate;
        if (r < acc) return g;
      }
      return grades[0];
    }
    function weaponClass(up) {
      if (up >= 15) return "weapon-mythic";
      if (up >= 10) return "weapon-legendary";
      if (up >= 5) return "weapon-epic";
      if (up >= 3) return "weapon-rare";
      return "weapon-common";
    }

    function buyGem() {
      if (coins >= 50) { coins -= 50; gems++; log("ë³´ì„ êµ¬ë§¤!"); }
      else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
      updateDisplay();
    }
    function buyWeapon() {
      if (coins >= 100) {
        coins -= 100;
        const templateIndex = weightedRandom(weapons);
        const template = weapons[templateIndex];
        const grade = randomGrade();

        const w = JSON.parse(JSON.stringify(template));
        w.grade = grade.name;
        w.gradeColor = grade.color;
        w.baseDamage = Math.round(randBetween(template.baseDamage[0], template.baseDamage[1]) * grade.stat);
        w.upgrade = 0;
        w.atkSpd = randBetween(template.atkSpdRange[0], template.atkSpdRange[1]);
        w.options = getRandomOptions(grade.name);
        inventory.push(w);
        log(`<span style='color:${grade.color}'>[${grade.name}]</span> ${w.name} (ê³µ:${w.baseDamage}, ì†ë„:${w.atkSpd}ms) íšë“!`);
        updateDisplay();
      } else log("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
    }

    function randBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ëœë¤ ì„ íƒ (ë‚®ì€ ì¸ë±ìŠ¤ì¼ìˆ˜ë¡ ë†’ì€ í™•ë¥ )
    function weightedRandom(array) {
      const weights = array.map((_, index) => Math.pow(2, array.length - index - 1));
      const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
      let random = Math.random() * totalWeight;

      for (let i = 0; i < array.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          return i;
        }
      }
      return array.length - 1;
    }

    function equip(i) {
      equipped = i;
      log(inventory[i].name + " ì¥ì°©!");
      updateDisplay();
      // ëª¬ìŠ¤í„°ê°€ ì‚´ì•„ìˆìœ¼ë©´ ì¥ì°© ì¦‰ì‹œ ì „íˆ¬ ì‹œì‘
      if (monsters.filter(m => m.alive).length > 0 && player.alive) {
        startAutoBattle();
      }
    }
    function sell(i) {
      let w = inventory[i];
      let value = 50; // ë¬´ê¸° êµ¬ë§¤ê°€ê²©(100ì½”ì¸)ì˜ ë°˜ê°’
      coins += value;
      log(`${w.name} íŒë§¤í•˜ì—¬ ${value}ì½”ì¸ íšë“`);

      // ì¥ì°©ëœ ë¬´ê¸° ì¸ë±ìŠ¤ ì¡°ì •
      if (equipped === i) {
        equipped = null; // íŒë§¤í•˜ëŠ” ë¬´ê¸°ê°€ ì¥ì°©ëœ ê²½ìš° í•´ì œ
      } else if (equipped !== null && equipped > i) {
        equipped--; // íŒë§¤ëœ ë¬´ê¸°ë³´ë‹¤ ë’¤ì— ìˆëŠ” ì¥ì°©ëœ ë¬´ê¸°ì˜ ì¸ë±ìŠ¤ ì¡°ì •
      }

      inventory.splice(i, 1);
      updateDisplay();
    }

    // ì „ì²´ ì•„ì´í…œ íŒë§¤ í•¨ìˆ˜ (ì¥ì°© ì¤‘ì¸ ì•„ì´í…œ ì œì™¸)
    function sellAllItems() {

      let totalValue = 0;
      let soldCount = 0;

      // ë¬´ê¸° íŒë§¤ (ì¥ì°©ëœ ë¬´ê¸° ì œì™¸)
      for (let i = inventory.length - 1; i >= 0; i--) {
        if (equipped !== i) {
          totalValue += 50; // ë¬´ê¸° íŒë§¤ ê°€ê²©
          soldCount++;
          inventory.splice(i, 1);

          // ì¥ì°©ëœ ë¬´ê¸° ì¸ë±ìŠ¤ ì¡°ì •
          if (equipped !== null && equipped > i) {
            equipped--;
          }
        }
      }

      // ë°©ì–´êµ¬ íŒë§¤ (ì¥ì°©ëœ ë°©ì–´êµ¬ ì œì™¸)
      for (let i = armorInventory.length - 1; i >= 0; i--) {
        if (equippedArmor !== i) {
          totalValue += 60; // ë°©ì–´êµ¬ íŒë§¤ ê°€ê²©
          soldCount++;
          armorInventory.splice(i, 1);

          // ì¥ì°©ëœ ë°©ì–´êµ¬ ì¸ë±ìŠ¤ ì¡°ì •
          if (equippedArmor !== null && equippedArmor > i) {
            equippedArmor--;
          }
        }
      }

      // ëª¨ì íŒë§¤ (ì¥ì°©ëœ ëª¨ì ì œì™¸)
      for (let i = helmetInventory.length - 1; i >= 0; i--) {
        if (equippedHelmet !== i) {
          totalValue += 40; // ëª¨ì íŒë§¤ ê°€ê²©
          soldCount++;
          helmetInventory.splice(i, 1);

          // ì¥ì°©ëœ ëª¨ì ì¸ë±ìŠ¤ ì¡°ì •
          if (equippedHelmet !== null && equippedHelmet > i) {
            equippedHelmet--;
          }
        }
      }

      // ë°”ì§€ íŒë§¤ (ì¥ì°©ëœ ë°”ì§€ ì œì™¸)
      for (let i = pantsInventory.length - 1; i >= 0; i--) {
        if (equippedPants !== i) {
          totalValue += 45; // ë°”ì§€ íŒë§¤ ê°€ê²©
          soldCount++;
          pantsInventory.splice(i, 1);

          // ì¥ì°©ëœ ë°”ì§€ ì¸ë±ìŠ¤ ì¡°ì •
          if (equippedPants !== null && equippedPants > i) {
            equippedPants--;
          }
        }
      }

      // ì‹ ë°œ íŒë§¤ (ì¥ì°©ëœ ì‹ ë°œ ì œì™¸)
      for (let i = shoesInventory.length - 1; i >= 0; i--) {
        if (equippedShoes !== i) {
          totalValue += 35; // ì‹ ë°œ íŒë§¤ ê°€ê²©
          soldCount++;
          shoesInventory.splice(i, 1);

          // ì¥ì°©ëœ ì‹ ë°œ ì¸ë±ìŠ¤ ì¡°ì •
          if (equippedShoes !== null && equippedShoes > i) {
            equippedShoes--;
          }
        }
      }

      // ëª©ê±¸ì´ íŒë§¤ (ì¥ì°©ëœ ëª©ê±¸ì´ ì œì™¸)
      for (let i = necklaceInventory.length - 1; i >= 0; i--) {
        if (equippedNecklace !== i) {
          totalValue += 75; // ëª©ê±¸ì´ íŒë§¤ ê°€ê²©
          soldCount++;
          necklaceInventory.splice(i, 1);

          // ì¥ì°©ëœ ëª©ê±¸ì´ ì¸ë±ìŠ¤ ì¡°ì •
          if (equippedNecklace !== null && equippedNecklace > i) {
            equippedNecklace--;
          }
        }
      }

      // ë°˜ì§€ íŒë§¤ (ì¥ì°©ëœ ë°˜ì§€ ì œì™¸)
      for (let i = ringInventory.length - 1; i >= 0; i--) {
        if (equippedRing !== i) {
          totalValue += 55; // ë°˜ì§€ íŒë§¤ ê°€ê²©
          soldCount++;
          ringInventory.splice(i, 1);

          // ì¥ì°©ëœ ë°˜ì§€ ì¸ë±ìŠ¤ ì¡°ì •
          if (equippedRing !== null && equippedRing > i) {
            equippedRing--;
          }
        }
      }

      // ê²°ê³¼ ì ìš©
      coins += totalValue;

      if (soldCount > 0) {
        log(`ì „ì²´ íŒë§¤ ì™„ë£Œ! ${soldCount}ê°œ ì•„ì´í…œì„ íŒë§¤í•˜ì—¬ ${totalValue}ì½”ì¸ íšë“`);
      } else {
        log("íŒë§¤í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë“  ì•„ì´í…œì´ ì¥ì°© ì¤‘ì´ê±°ë‚˜ ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ)");
      }

      updateDisplay();
    }

    function upgrade(i, type) {
      let item, arr;
      if (type === 'armor') {
        arr = armorInventory;
        item = arr[i];
      } else if (type === 'helmet') {
        arr = helmetInventory;
        item = arr[i];
      } else if (type === 'pants') {
        arr = pantsInventory;
        item = arr[i];
      } else if (type === 'shoes') {
        arr = shoesInventory;
        item = arr[i];
      } else if (type === 'necklace') {
        arr = necklaceInventory;
        item = arr[i];
      } else if (type === 'ring') {
        arr = ringInventory;
        item = arr[i];
      } else {
        arr = inventory;
        item = arr[i];
      }
      let cost = Math.max(1, Math.floor((item.upgrade || 0) * 0.8) + 1);
      if (gems >= cost) {
        gems -= cost;
        if (item.upgrade >= 12 && Math.random() < 0.2) {
          log(`${item.name} ê°•í™” ì‹¤íŒ¨! íŒŒê´´ë¨`);
          if (type === 'armor' && equippedArmor === i) {
            equippedArmor = null;
            player.def = 0;
          }
          if (type !== 'armor' && equipped === i) equipped = null;
          arr.splice(i, 1);
        } else {
          item.upgrade = (item.upgrade || 0) + 1;
          log(`${item.name} ê°•í™” ì„±ê³µ! +${item.upgrade}`);
        }
      } else log("ë³´ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");
      updateDisplay();
    }

    function spawnMonster() {
      if (autoBattleInterval) clearInterval(autoBattleInterval);

      // ì‚¬ëƒ¥í„°ë³„ ëª¬ìŠ¤í„° ëŠ¥ë ¥ì¹˜ ë° ê°œìˆ˜
      const f = fields[currentField];

      // ì´ˆë°˜ (ì²˜ì¹˜í•œ ëª¬ìŠ¤í„° ìˆ˜ê°€ 20ë§ˆë¦¬ ë¯¸ë§Œ)ì—ëŠ” í•­ìƒ 1ë§ˆë¦¬ì”©ë§Œ
      let spawnCount;
      if (totalMonstersKilled < 20) {
        spawnCount = 1;
      } else {
        // ë‚˜ì¤‘ì—ëŠ” ëœë¤ìœ¼ë¡œ ëª¬ìŠ¤í„° ìˆ˜ ê²°ì •
        const minCount = f.monsterCount[0];
        const maxCount = f.monsterCount[1];
        spawnCount = minCount + Math.floor(Math.random() * (maxCount - minCount + 1));
      }

      // ì´ë¯¸ ì‚´ì•„ìˆëŠ” ëª¬ìŠ¤í„°ê°€ ìˆìœ¼ë©´ ìƒì„±í•˜ì§€ ì•ŠìŒ
      if (monsters.filter(m => m.alive).length > 0) return;

      // ì£½ì€ ëª¬ìŠ¤í„°ë“¤ì„ ë°°ì—´ì—ì„œ ì œê±°
      monsters = monsters.filter(m => m.alive);

      let spawnedNames = [];

      for (let i = 0; i < spawnCount; i++) {
        const monsterType = monsterTypes[currentField][Math.floor(Math.random() * monsterTypes[currentField].length)];
        const newMonster = {
          id: monsterIdCounter++, // ê³ ìœ  ID ì¶”ê°€
          hp: f.hp[0] + Math.floor(Math.random() * (f.hp[1] - f.hp[0] + 1)),
          maxHp: 0,
          atk: f.atk[0] + Math.floor(Math.random() * (f.atk[1] - f.atk[0] + 1)),
          def: f.def[0] + Math.floor(Math.random() * (f.def[1] - f.def[0] + 1)),
          atkSpd: monsterAtkSpd,
          alive: true,
          name: monsterType.name,
          emoji: monsterType.emoji
        };
        newMonster.maxHp = newMonster.hp;
        monsters.push(newMonster);
        spawnedNames.push(newMonster.name);
      }

      updateMonstersDisplay();
      const spawnMsg = `${spawnedNames.join(', ')} ë“±ì¥!`;
      battleLog(spawnMsg);
      showBattleInfo(spawnMsg);
      updatePlayerStats(); // ìŠ¤í…œ ë¨¼ì € ì—…ë°ì´íŠ¸
      player.hp = player.maxHp + player.bonusHp; // ëª©ê±¸ì´ ì²´ë ¥ í¬í•¨
      player.alive = true;
      updatePlayerArea();
      // ë¬´ê¸° ë¯¸ì¥ì°© ì‹œ ì•ˆë‚´, ì¥ì°© ì‹œ ìë™ì „íˆ¬ ì‹œì‘
      if (equipped != null && inventory[equipped]) {
        startAutoBattle();
        updateUIVisibility(); // ì „íˆ¬ ì‹œì‘ ì‹œ UI ì—…ë°ì´íŠ¸
      } else {
        const equipMsg = "ë¬´ê¸°ë¥¼ ì¥ì°©í•´ì•¼ ê³µê²©ì´ ì‹œì‘ë©ë‹ˆë‹¤!";
        battleLog(equipMsg);
        showBattleInfo(equipMsg);
      }
    }

    function updateMonstersDisplay() {
      const container = document.getElementById("monstersContainer");

      if (monsters.length === 0) {
        container.innerHTML = '<div class="monster-info">ëª¬ìŠ¤í„° ì—†ìŒ</div>';
        return;
      }

      // ê¸°ì¡´ ëª¬ìŠ¤í„° ìš”ì†Œë“¤ì„ í™•ì¸í•˜ê³  í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
      const existingMonsters = container.querySelectorAll('.monster-unit');
      const aliveMonsters = monsters.filter(m => m.alive);

      // ì‚´ì•„ìˆëŠ” ëª¬ìŠ¤í„° ìˆ˜ê°€ ë‹¤ë¥´ê±°ë‚˜ ëª¬ìŠ¤í„°ê°€ ì—†ìœ¼ë©´ ì „ì²´ ì¬ìƒì„±
      if (existingMonsters.length !== aliveMonsters.length || aliveMonsters.length === 0) {
        let html = '';
        aliveMonsters.forEach((monster, index) => {
          const percent = Math.max(0, Math.round(monster.hp / monster.maxHp * 100));
          html += `
            <div class="monster-unit" id="monster${monster.id}" style="padding:4px; margin-bottom:2px; min-width:90px; position:relative;">
              <div class="monster-name" style="font-size:11px; color:#ff6b6b; margin-bottom:2px; font-weight:bold;">${monster.name}</div>
              <div class="monster-hp" style="font-size:10px; color:#ccc;">HP: ${Math.floor(monster.hp)}/${monster.maxHp}</div>
              <div style='background:#444;width:100%;height:10px;border-radius:5px;margin:2px 0;position:relative;overflow:hidden;'>
                <div class="hp-bar" style='background:#fa4;height:100%;width:${percent}%;border-radius:5px;transition:width 0.2s;position:absolute;left:0;top:0;'></div>
              </div>
            </div>
          `;
        });

        if (html === '') {
          container.innerHTML = '<div class="monster-info">ëª¬ìŠ¤í„° ì—†ìŒ</div>';
        } else {
          container.innerHTML = `<div class="monsters-scroll-area">${html}</div>`;
        }
      } else {
        // ê¸°ì¡´ ìš”ì†Œë“¤ì˜ HPë§Œ ì—…ë°ì´íŠ¸
        aliveMonsters.forEach(monster => {
          const monsterElement = document.getElementById(`monster${monster.id}`);
          if (monsterElement) {
            const hpText = monsterElement.querySelector('.monster-hp');
            const hpBar = monsterElement.querySelector('.hp-bar');
            if (hpText) {
              hpText.textContent = `HP: ${Math.floor(monster.hp)}/${monster.maxHp}`;
            }
            if (hpBar) {
              const percent = Math.max(0, Math.round(monster.hp / monster.maxHp * 100));
              hpBar.style.width = `${percent}%`;
            }
          }
        });
      }
    }
    // ê¸°ì¡´ updateMonsterArea í•¨ìˆ˜ëŠ” updateMonstersDisplayë¡œ ëŒ€ì²´ë¨

    // ìë™ì „íˆ¬ ë£¨í”„
    function startAutoBattle() {
      if (autoBattleInterval) clearInterval(autoBattleInterval);
      let atkSpd = player.atkSpd;
      if (equipped != null && inventory[equipped] && inventory[equipped].atkSpd) {
        let w = inventory[equipped];
        let upgrade = w.upgrade || 0;
        let spdBonus = Math.max(1 - 0.02 * upgrade, 0.5); // ìµœì†Œ 50%ê¹Œì§€ ë¹¨ë¼ì§
        atkSpd = Math.floor(w.atkSpd * spdBonus);

        // ê³µê²© ì†ë„ í¼ì„¼íŠ¸ ì¦ê°€ ì ìš©
        let speedPercent = getUniqueOptionValue('speed_percent');
        if (speedPercent > 0) {
          atkSpd = Math.floor(atkSpd * (1 - speedPercent / 100)); // ì†ë„ëŠ” ë‚®ì„ìˆ˜ë¡ ë¹ ë¦„
        }
      }
      autoBattleInterval = setInterval(() => {
        const aliveMonsters = monsters.filter(m => m.alive);
        if (aliveMonsters.length === 0 || !player.alive) {
          clearInterval(autoBattleInterval);
          return;
        }
        playerAttack();
        setTimeout(monsterAttack, Math.floor(monsterAtkSpd / 2));
      }, atkSpd);
    }

    function playerAttack() {
      const aliveMonsters = monsters.filter(m => m.alive);
      if (aliveMonsters.length === 0) return;
      if (equipped == null) { log("ë¬´ê¸°ë¥¼ ì¥ì°©í•˜ì„¸ìš”"); return; }

      // ëœë¤í•˜ê²Œ ì‚´ì•„ìˆëŠ” ëª¬ìŠ¤í„° ì¤‘ í•˜ë‚˜ ì„ íƒ
      const targetMonster = aliveMonsters[Math.floor(Math.random() * aliveMonsters.length)];

      // ê³µê²© ì• ë‹ˆë©”ì´ì…˜
      const characterSprite = document.getElementById("characterSprite");

      characterSprite.classList.add("attacking");
      setTimeout(() => characterSprite.classList.remove("attacking"), 300);

      let w = inventory[equipped];
      // ê°•í™” íš¨ê³¼ ì ìš©: ê³µê²©ë ¥, ê³µê²©ì†ë„, íŠ¹ìˆ˜íš¨ê³¼ í™•ë¥  ì¦ê°€
      let upgrade = w.upgrade || 0;
      let baseDamage = w.baseDamage || 0;
      let bonusAtk = player.bonusAtk || 0;

      // NaN ì²´í¬
      if (isNaN(baseDamage)) baseDamage = 0;
      if (isNaN(upgrade)) upgrade = 0;
      if (isNaN(bonusAtk)) bonusAtk = 0;

      let dmg = baseDamage + upgrade * 2 + bonusAtk; // ë°˜ì§€ ê³µê²©ë ¥ ì¶”ê°€

      // NaN ì²´í¬
      if (isNaN(dmg) || dmg < 0) {
        dmg = 1; // ìµœì†Œ 1 ë°ë¯¸ì§€
      }
      let extraMsg = "";
      // ê°•í™” ì‹œ íŠ¹ìˆ˜íš¨ê³¼ í™•ë¥  1%pì”© ì¦ê°€, ê³µê²©ì†ë„ 2%ì”© ë¹¨ë¼ì§(ìµœëŒ€ 50% ê°ì†Œ)
      let effectBonus = Math.min(0.01 * upgrade, 0.5);
      // ê³µê²©ì†ë„ ì ìš©(ìë™ì „íˆ¬ ë£¨í”„ì—ì„œ ë°˜ì˜)
      // íŠ¹ìˆ˜íš¨ê³¼ í™•ë¥  ì¦ê°€ ì ìš©
      let defenseIgnored = false;
      if (w.name == "ë¡±ì†Œë“œ" && Math.random() < 0.2 + effectBonus) { dmg *= 2; extraMsg = "(2ë°° ë°ë¯¸ì§€!)"; }
      if (w.name == "ë„ë¼" && Math.random() < 0.1 + effectBonus) { dmg *= 3; extraMsg = "(ì¹˜ëª…íƒ€!)"; }
      if (w.name == "ë‹¨ê²€" && Math.random() < 0.3 + effectBonus) {
        // ë°©ì–´ë ¥ ì ìš©
        let monsterDef = targetMonster.def || 0;
        if (isNaN(monsterDef) || monsterDef < 0) {
          monsterDef = 0;
        }
        let reduced = Math.max(1, dmg * (200 / (200 + monsterDef)));
        if (isNaN(reduced) || reduced < 0) {
          reduced = 1;
        }
        targetMonster.hp -= reduced;
        extraMsg = "(ì¶”ê°€íƒ€ê²©!)";
      }
      if (w.name == "ë§ˆë²•ë´‰" && Math.random() < 0.2 + effectBonus) {
        let extraDmg = Math.floor(targetMonster.hp * 0.1);
        if (isNaN(extraDmg) || extraDmg < 0) {
          extraDmg = 0;
        }
        dmg += extraDmg;
        extraMsg = "(ì¶”ê°€í”¼í•´)";
      }
      if (w.name == "í™œ" && Math.random() < 0.15 + effectBonus) { defenseIgnored = true; extraMsg = "(ë°©ì–´ë¬´ì‹œ)"; }

      // ë°©ì–´ë ¥ ì ìš© (í™œì˜ ë°©ì–´ë¬´ì‹œ íš¨ê³¼ê°€ ìˆìœ¼ë©´ ìŠ¤í‚µ)
      let finalDamage = dmg;
      if (!defenseIgnored) {
        let monsterDef = targetMonster.def || 0;
        if (isNaN(monsterDef) || monsterDef < 0) {
          monsterDef = 0;
        }
        finalDamage = Math.max(1, dmg * (200 / (200 + monsterDef)));
      }

      // NaN ì²´í¬
      if (isNaN(finalDamage) || finalDamage < 0) {
        finalDamage = 1;
      }

      // ìœ ë‹ˆí¬ ê³µê²© íš¨ê³¼ ì²˜ë¦¬
      const uniqueEffects = processUniqueAttackEffects(targetMonster, finalDamage);
      let extraDamage = uniqueEffects.extraDamage || 0;
      if (isNaN(extraDamage)) {
        extraDamage = 0;
      }
      finalDamage += extraDamage;
      extraMsg += uniqueEffects.extraMessage;

      // ìµœì¢… NaN ì²´í¬
      if (isNaN(finalDamage) || finalDamage < 0) {
        finalDamage = 1;
      }

      // ë°ë¯¸ì§€ ì ìš©
      targetMonster.hp -= finalDamage;

      // ëª¬ìŠ¤í„°ì—ê²Œ ë°ë¯¸ì§€ íŒì—… í‘œì‹œ
      setTimeout(() => {
        showMonsterDamagePopup(targetMonster.id, finalDamage, 'damage');
      }, 50); // ì•½ê°„ì˜ ì§€ì—°ì„ ì£¼ì–´ DOMì´ ì—…ë°ì´íŠ¸ëœ í›„ ì‹¤í–‰

      battleLog(`${w.name}ìœ¼ë¡œ ${targetMonster.name} ê³µê²©! ${Math.floor(dmg)} â†’ ${Math.floor(finalDamage)} ë°ë¯¸ì§€ ${extraMsg}${!defenseIgnored ? " (ë°©ì–´ë ¥ ì ìš©)" : ""}`);

      // ëª¬ìŠ¤í„° ì‚¬ë§ ì²´í¬
      if (targetMonster.hp <= 0) {
        targetMonster.alive = false;
        let reward = fields[currentField].reward;

        // ê³¨ë“œ íšë“ í¼ì„¼íŠ¸ ì¦ê°€ ì ìš©
        let goldPercent = getUniqueOptionValue('gold_percent');
        if (goldPercent > 0) {
          reward = Math.floor(reward * (1 + goldPercent / 100));
        }

        // ë³´ì„ ë“œë¡­ í™•ë¥  (ê¸°ë³¸ 10% + ë§ˆë‚˜ í¡ìˆ˜ íš¨ê³¼ + ê³ ë ˆë²¨ ì‚¬ëƒ¥í„° ë³´ë„ˆìŠ¤)
        let gemDropChance = 10;
        let manaDrainValue = getUniqueOptionValue('mana_drain');
        if (manaDrainValue > 0) {
          gemDropChance += manaDrainValue;
        }

        // ê³ ë ˆë²¨ ì‚¬ëƒ¥í„°ì—ì„œ ë³´ì„ ë“œë¡­ í™•ë¥  ì¦ê°€
        if (currentField >= 4) { // ë¹™í•˜ ì´ìƒ
          gemDropChance += (currentField - 3) * 5; // ì‚¬ëƒ¥í„°ë§ˆë‹¤ 5%ì”© ì¦ê°€
        }

        // íŠ¹ë³„ ë³´ìƒ (ê³ ë ˆë²¨ ì‚¬ëƒ¥í„°)
        let bonusGems = 0;
        if (currentField >= 7) { // ì²œê³µì„± ì´ìƒ
          if (Math.random() * 100 < 3) { // 3% í™•ë¥ ë¡œ ë³´ì„ ëŒ€ëŸ‰ íšë“
            bonusGems = Math.floor(Math.random() * 3) + 2; // 2-4ê°œ
          }
        }
        if (currentField >= 9) { // ì‹œê³µì˜ í‹ˆ ì´ìƒ
          if (Math.random() * 100 < 1) { // 1% í™•ë¥ ë¡œ ë³´ì„ ëŒ€ë°•
            bonusGems = Math.floor(Math.random() * 5) + 5; // 5-9ê°œ
          }
        }

        const gemDrop = Math.random() * 100 < gemDropChance;
        let rewardMsg = `${targetMonster.name} ì²˜ì¹˜! ì½”ì¸+${reward}`;

        let totalGemsGained = 0;
        if (gemDrop) {
          totalGemsGained += 1;
        }
        if (bonusGems > 0) {
          totalGemsGained += bonusGems;
          rewardMsg += ` âœ¨ë³´ë„ˆìŠ¤!`;
        }

        if (totalGemsGained > 0) {
          gems += totalGemsGained;
          rewardMsg += `, ë³´ì„+${totalGemsGained}`;
        }
        battleLog(rewardMsg);
        showBattleInfo(rewardMsg);
        coins += reward;
        totalMonstersKilled++; // ì²˜ì¹˜í•œ ëª¬ìŠ¤í„° ìˆ˜ ì¦ê°€

        // ì£½ì€ ëª¬ìŠ¤í„°ëŠ” ë°°ì—´ì—ì„œ ì œê±°í•˜ì§€ ì•Šê³  aliveë§Œ falseë¡œ ì„¤ì •
        // ë‹¤ìŒ ì „íˆ¬ì—ì„œ ì •ë¦¬ë¨
      }

      // ëª¨ë“  ëª¬ìŠ¤í„°ê°€ ì£½ì—ˆëŠ”ì§€ í™•ì¸
      const remainingMonsters = monsters.filter(m => m.alive);
      if (remainingMonsters.length === 0) {
        clearInterval(autoBattleInterval);
        updateUIVisibility(); // ëª¨ë“  ëª¬ìŠ¤í„° ì‚¬ë§ ì‹œ UI ì—…ë°ì´íŠ¸
        // ìë™ì‚¬ëƒ¥ ëª¨ë“œë©´ ì¼ì • ì‹œê°„ í›„ ìë™ ëª¬ìŠ¤í„° ë“±ì¥
        if (autoHunt) {
          if (autoHuntTimeout) clearTimeout(autoHuntTimeout);
          // ê¸°ë³¸ ë”œë ˆì´ 3ì´ˆ, ì í”„ë ¥ì— ë”°ë¼ ê°ì†Œ (ìµœì†Œ 0.5ì´ˆ)
          const baseDelay = 3000;
          const jumpReduction = player.jump * 50; // ì í”„ë ¥ 1ë‹¹ 50ms ê°ì†Œ
          const finalDelay = Math.max(500, baseDelay - jumpReduction);
          autoHuntTimeout = setTimeout(() => {
            spawnMonster();
          }, finalDelay);
        }
      }
      updateDisplay();
    }

    function monsterAttack() {
      const aliveMonsters = monsters.filter(m => m.alive);
      if (aliveMonsters.length === 0 || !player.alive) return;

      let totalDamage = 0;
      let attackMessages = [];

      // íšŒí”¼ ì²´í¬
      if (Math.random() * 100 < player.dodge) {
        // íšŒí”¼ ì„±ê³µ
        const characterSprite = document.getElementById("characterSprite");
        battleLog(`íšŒí”¼ ì„±ê³µ! (íšŒí”¼ìœ¨: ${player.dodge}%)`);
        showDamagePopup(document.getElementById("characterSprite"), "íšŒí”¼!", 'heal');
        return;
      }

      // ëª¨ë“  ì‚´ì•„ìˆëŠ” ëª¬ìŠ¤í„°ê°€ í”Œë ˆì´ì–´ ê³µê²©
      aliveMonsters.forEach(monster => {
        // ëª¬ìŠ¤í„° ê³µê²© ì• ë‹ˆë©”ì´ì…˜
        const monsterElement = document.getElementById(`monster${monster.id}`);
        if (monsterElement) {
          monsterElement.classList.add("attacking");
          setTimeout(() => {
            if (monsterElement.classList) {
              monsterElement.classList.remove("attacking");
            }
          }, 300);
        }

        let dmg = monster.atk || 0;

        // NaN ì²´í¬
        if (isNaN(dmg) || dmg < 0) {
          dmg = 0;
        }

        // ë°©ì–´ë ¥ ì ìš©
        let playerDef = player.def || 0;
        if (isNaN(playerDef) || playerDef < 0) {
          playerDef = 0;
        }

        let reduced = Math.max(0, dmg * (200 / (200 + playerDef)));

        // NaN ì²´í¬
        if (isNaN(reduced)) {
          reduced = 0;
        }

        totalDamage += reduced;
        attackMessages.push(`${monster.name}: ${Math.floor(dmg)} â†’ ${Math.floor(reduced)} ë°ë¯¸ì§€`);
      });

      // ìœ ë‹ˆí¬ ë°©ì–´ íš¨ê³¼ ì²˜ë¦¬
      const defenseEffects = processUniqueDefenseEffects(totalDamage);

      if (defenseEffects.negateAttack) {
        // ê³µê²© ë¬´íš¨í™”
        battleLog(`ëª¬ìŠ¤í„°ë“¤ì˜ ê³µê²©! í•˜ì§€ë§Œ ë¬´íš¨í™”ë¨!${defenseEffects.extraMessage}`);
        if (defenseEffects.reflectDamage > 0) {
          battleLog(`ë°˜ì‚¬ ë°ë¯¸ì§€ ${defenseEffects.reflectDamage}!`);
        }
        return;
      }

      // í”Œë ˆì´ì–´ í”¼ê²© ì• ë‹ˆë©”ì´ì…˜
      const characterSprite = document.getElementById("characterSprite");
      characterSprite.classList.add("hurt");
      setTimeout(() => characterSprite.classList.remove("hurt"), 300);

      // ë°ë¯¸ì§€ ì ìš©
      let damageReduction = defenseEffects.damageReduction || 0;
      if (isNaN(damageReduction)) {
        damageReduction = 0;
      }

      totalDamage -= damageReduction;
      totalDamage = Math.max(0, totalDamage);

      // NaN ì²´í¬
      if (isNaN(totalDamage)) {
        totalDamage = 0;
      }

      player.hp -= totalDamage;

      // í”Œë ˆì´ì–´ ë°ë¯¸ì§€ íŒì—… í‘œì‹œ
      if (totalDamage > 0) {
        showDamagePopup(characterSprite, totalDamage, 'damage');
      }

      let damageMessage = `ëª¬ìŠ¤í„°ë“¤ì˜ ê³µê²©! ${attackMessages.join(', ')} (ì´ ${Math.floor(totalDamage)} ë°ë¯¸ì§€)${defenseEffects.extraMessage}`;
      if (defenseEffects.reflectDamage > 0) {
        damageMessage += ` ë°˜ì‚¬ ë°ë¯¸ì§€ ${defenseEffects.reflectDamage}!`;
      }
      battleLog(damageMessage);

      if (player.hp <= 0) {
        player.hp = 0;
        player.alive = false;
        const deathMsg = "í”Œë ˆì´ì–´ ì‚¬ë§! ë³´ìœ ê¸ˆì•¡ 1/2.";
        battleLog(deathMsg);
        showBattleInfo(deathMsg, 3000);
        if (coins != 0) {
          coins = Math.floor(coins / 2);
        }
        clearInterval(autoBattleInterval);
        updateUIVisibility(); // í”Œë ˆì´ì–´ ì‚¬ë§ ì‹œ UI ì—…ë°ì´íŠ¸
      }
      updateDisplay();
    }

    setInterval(() => { coins += 2; updateDisplay(); }, 1000);
  </script>
</body>

</html>